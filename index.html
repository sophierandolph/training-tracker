<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#0f0a1a">
  <title>Training Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAyK68HpCXZEojCG3rM6T51mynd6DfnaVY",
      authDomain: "training-tracker-74124.firebaseapp.com",
      databaseURL: "https://training-tracker-74124-default-rtdb.firebaseio.com",
      projectId: "training-tracker-74124",
      storageBucket: "training-tracker-74124.firebasestorage.app",
      messagingSenderId: "1018516149801",
      appId: "1:1018516149801:web:8afcdc10aaa272e4bf6e38"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Enable offline persistence
    db.enablePersistence().catch((err) => {
      console.log('Offline persistence error:', err.code);
    });
  </script>
  <style>
    :root {
      /* Deep purple palette - rich and powerful */
      --bg-primary: #0f0a1a;
      --bg-secondary: #1a1228;
      --bg-card: #251a38;
      --bg-elevated: #2f2245;

      /* Jewel tone accents */
      --accent: #a855f7;
      --accent-light: #c084fc;
      --accent-glow: rgba(168, 85, 247, 0.3);

      /* Complementary jewel tones */
      --emerald: #10b981;
      --emerald-glow: rgba(16, 185, 129, 0.25);
      --gold: #f59e0b;
      --gold-glow: rgba(245, 158, 11, 0.2);
      --rose: #f43f5e;
      --teal: #14b8a6;

      /* Text */
      --text-primary: #f5f3ff;
      --text-secondary: #a8a3b8;
      --text-muted: #6b6280;

      /* Functional */
      --success: #10b981;
      --warning: #f59e0b;
      --border: #3d2a5c;
      --border-light: #4a3768;

      /* Design tokens */
      --radius: 18px;
      --radius-sm: 12px;
      --radius-full: 9999px;
      --shadow-glow: 0 0 20px var(--accent-glow);
      --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.3);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Figtree', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      background-image:
        radial-gradient(ellipse at top, rgba(168, 85, 247, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(16, 185, 129, 0.05) 0%, transparent 40%);
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
    }

    /* Header */
    header {
      background: linear-gradient(180deg, var(--bg-secondary) 0%, rgba(26, 18, 40, 0.95) 100%);
      backdrop-filter: blur(10px);
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .date-display {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    .day-name {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.3px;
    }

    /* Readiness Badge */
    .readiness-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-card);
      padding: 10px 16px;
      border-radius: var(--radius-full);
      cursor: pointer;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .readiness-badge:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-glow);
    }

    .readiness-score {
      font-size: 20px;
      font-weight: 700;
    }

    .readiness-label {
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .readiness-high { color: var(--emerald); }
    .readiness-mid { color: var(--gold); }
    .readiness-low { color: var(--rose); }

    /* Workout Header */
    .workout-header {
      padding: 24px;
      background: var(--bg-card);
      margin: 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .workout-header::before {
      content: '';
      position: absolute;
      top: -20px;
      right: -20px;
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.4;
    }

    .workout-type {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--accent-light);
      letter-spacing: 1.2px;
      margin-bottom: 6px;
      font-weight: 700;
    }

    .workout-title {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 10px;
      position: relative;
      letter-spacing: -0.3px;
    }

    .workout-meta {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .workout-meta span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Progress Bar */
    .progress-container {
      padding: 0 20px;
      margin-bottom: 20px;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-card);
      border-radius: var(--radius-full);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--emerald) 100%);
      border-radius: var(--radius-full);
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px var(--accent-glow);
    }

    /* Circuit Section */
    .circuit-section {
      margin: 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .circuit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 18px;
      background: var(--bg-card);
      cursor: pointer;
    }

    .circuit-header h3 {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.2px;
    }

    .circuit-instructions {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .circuit-status {
      font-size: 12px;
      color: var(--text-secondary);
      background: var(--bg-primary);
      padding: 4px 10px;
      border-radius: var(--radius-full);
    }

    .circuit-status.complete {
      color: var(--emerald);
      background: var(--emerald-glow);
    }

    /* Exercise Card */
    .exercise-card {
      padding: 18px;
      border-bottom: 1px solid var(--border);
      transition: var(--transition);
    }

    .exercise-card:last-child {
      border-bottom: none;
    }

    .exercise-card:hover {
      background: rgba(168, 85, 247, 0.03);
    }

    .exercise-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 14px;
    }

    .exercise-name {
      font-size: 16px;
      font-weight: 600;
      flex: 1;
      color: var(--text-primary);
    }

    .exercise-target {
      font-size: 13px;
      color: var(--accent-light);
      margin-top: 4px;
      font-weight: 500;
    }

    .exercise-notes {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
      line-height: 1.4;
    }

    .skip-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 12px;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: var(--transition);
    }

    .skip-btn:hover {
      color: var(--rose);
      background: rgba(244, 63, 94, 0.1);
    }

    /* Set Tracker */
    .sets-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .set-pill {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius-full);
      padding: 10px 16px;
      min-width: 72px;
      cursor: pointer;
      transition: var(--transition);
    }

    .set-pill:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.2);
    }

    .set-pill.active {
      border-color: var(--accent);
      box-shadow: var(--shadow-glow);
    }

    .set-pill.complete {
      border-color: var(--emerald);
      background: var(--emerald-glow);
    }

    .set-pill.skipped {
      border-color: var(--text-muted);
      opacity: 0.5;
    }

    .set-number {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .set-value {
      font-size: 17px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Input Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 10, 26, 0.9);
      backdrop-filter: blur(8px);
      z-index: 200;
      align-items: flex-end;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-content {
      background: linear-gradient(180deg, var(--bg-elevated) 0%, var(--bg-secondary) 100%);
      width: 100%;
      max-width: 500px;
      border-radius: 24px 24px 0 0;
      padding: 28px 24px;
      padding-bottom: 44px;
      border-top: 1px solid var(--border-light);
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      background: var(--bg-card);
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: var(--radius-full);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .modal-close:hover {
      background: var(--border);
      color: var(--text-primary);
    }

    .input-group {
      margin-bottom: 24px;
    }

    .input-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 10px;
      display: block;
      letter-spacing: 0.8px;
      font-weight: 500;
    }

    .input-row {
      display: flex;
      gap: 14px;
    }

    .input-field {
      flex: 1;
    }

    .input-field input {
      width: 100%;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
      text-align: center;
      transition: var(--transition);
    }

    .input-field input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: var(--shadow-glow);
    }

    .input-field input::placeholder {
      color: var(--text-muted);
    }

    .input-field label {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 6px;
    }

    /* Feel Slider */
    .feel-slider {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .feel-btn {
      flex: 1;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 4px;
      cursor: pointer;
      transition: var(--transition);
    }

    .feel-btn:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .feel-btn.selected {
      border-color: var(--accent);
      background: var(--accent-glow);
      box-shadow: var(--shadow-glow);
    }

    .feel-btn .number {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .feel-btn .label {
      font-size: 9px;
      color: var(--text-muted);
      display: block;
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Effort Type Selector */
    .effort-type-selector {
      display: flex;
      gap: 10px;
    }

    .effort-type-btn {
      flex: 1;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 10px;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .effort-type-btn:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .effort-type-btn.selected {
      border-color: var(--accent);
      background: var(--accent-glow);
    }

    .effort-type-btn .type-icon {
      font-size: 24px;
      display: block;
      margin-bottom: 6px;
    }

    .effort-type-btn .type-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      display: block;
    }

    .effort-type-btn .type-desc {
      font-size: 10px;
      color: var(--text-muted);
      display: block;
      margin-top: 4px;
    }

    /* Modal Buttons */
    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 28px;
    }

    .btn {
      flex: 1;
      padding: 18px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #9333ea 100%);
      color: white;
      box-shadow: 0 4px 15px var(--accent-glow);
    }

    .btn-primary:hover {
      box-shadow: 0 6px 20px var(--accent-glow);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-elevated);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--emerald) 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 15px var(--emerald-glow);
    }

    .btn-success:hover {
      box-shadow: 0 6px 20px var(--emerald-glow);
      transform: translateY(-1px);
    }

    /* Timer */
    .rest-timer {
      display: none;
      position: fixed;
      bottom: 85px;
      left: 16px;
      right: 16px;
      background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-card) 100%);
      border: 2px solid var(--accent);
      border-radius: var(--radius);
      padding: 18px 20px;
      z-index: 150;
      box-shadow: var(--shadow-glow), var(--shadow-soft);
    }

    .rest-timer.active {
      display: block;
      animation: slideUp 0.3s ease;
    }

    .timer-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .timer-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .timer-display {
      font-size: 36px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: var(--accent-light);
    }

    .timer-btn {
      background: linear-gradient(135deg, var(--accent) 0%, #9333ea 100%);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: var(--radius-full);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .timer-btn:hover {
      transform: scale(1.05);
    }

    /* Workout Complete Modal */
    .complete-modal {
      text-align: center;
    }

    .complete-modal h2 {
      font-size: 28px;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-light) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .complete-modal p {
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 28px;
    }

    .stat-box {
      background: var(--bg-card);
      padding: 18px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-light);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Overall Feel */
    .overall-feel {
      margin-bottom: 24px;
    }

    .overall-slider {
      display: flex;
      gap: 6px;
    }

    .overall-btn {
      flex: 1;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 2px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      transition: var(--transition);
    }

    .overall-btn:hover {
      border-color: var(--border-light);
    }

    .overall-btn.selected {
      border-color: var(--accent);
      background: var(--accent-glow);
    }

    /* Notes */
    .notes-input {
      width: 100%;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px;
      font-size: 14px;
      color: var(--text-primary);
      resize: none;
      min-height: 90px;
      font-family: inherit;
      transition: var(--transition);
    }

    .notes-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: var(--shadow-glow);
    }

    .notes-input::placeholder {
      color: var(--text-muted);
    }

    /* Readiness Modal */
    .readiness-modal .input-field input {
      font-size: 36px;
    }

    /* Bottom Nav */
    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 10px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      transition: var(--transition);
    }

    .nav-item:hover {
      color: var(--text-primary);
      background: rgba(168, 85, 247, 0.1);
    }

    .nav-item.active {
      color: var(--accent-light);
      background: var(--accent-glow);
    }

    .nav-icon {
      font-size: 22px;
      transition: var(--transition);
    }

    .nav-item.active .nav-icon {
      transform: scale(1.1);
      filter: drop-shadow(0 0 6px var(--accent));
    }

    /* Views */
    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    /* History View */
    .history-section {
      padding: 16px;
    }

    .history-section h2 {
      color: var(--text-primary);
      font-weight: 800;
    }

    .history-day {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: 14px;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .history-day:hover {
      border-color: var(--border-light);
    }

    .history-date {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .history-workout {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .history-stats {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .history-stats span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Plan View */
    .plan-section {
      padding: 16px;
    }

    .plan-section h2 {
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.2px;
    }

    .week-progress-summary {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .week-progress-summary::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, var(--emerald-glow) 0%, transparent 70%);
      opacity: 0.3;
    }

    .week-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      position: relative;
    }

    .week-progress-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .week-progress-count {
      font-size: 14px;
      color: var(--emerald);
      font-weight: 700;
    }

    .week-progress-bar {
      height: 10px;
      background: var(--bg-primary);
      border-radius: var(--radius-full);
      overflow: hidden;
      border: 1px solid var(--border);
      position: relative;
    }

    .week-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--emerald) 0%, var(--teal) 50%, var(--accent-light) 100%);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 12px var(--emerald-glow);
    }

    /* Calendar Grid */
    .calendar-container {
      margin-bottom: 24px;
    }

    .calendar-week {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .calendar-week.current-week {
      border: 2px solid var(--accent);
      box-shadow: 0 0 20px var(--accent-glow);
    }

    .calendar-week-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
    }

    .calendar-week-label .week-dates {
      font-size: 10px;
      color: var(--text-muted);
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .calendar-day {
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      padding: 8px 4px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      min-height: 62px;
      border: 1px solid transparent;
    }

    .calendar-day:hover {
      background: var(--bg-elevated);
      border-color: var(--border-light);
      transform: translateY(-1px);
    }

    .calendar-day.today {
      border: 2px solid var(--accent);
      background: var(--accent-glow);
      box-shadow: 0 0 12px var(--accent-glow);
    }

    .calendar-day.past {
      opacity: 0.5;
    }

    .calendar-day-name {
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 2px;
      letter-spacing: 0.5px;
    }

    .calendar-day-number {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .calendar-day-workout {
      font-size: 8px;
      color: var(--accent-light);
      line-height: 1.3;
      word-wrap: break-word;
      font-weight: 500;
    }

    .calendar-day-workout.rest {
      color: var(--text-muted);
    }

    .calendar-day-workout.external {
      color: var(--gold);
    }

    .calendar-day-workout.travel {
      color: var(--teal);
    }

    /* Handball training travel - highlighted emerald */
    .calendar-day-workout.handball-training {
      color: var(--emerald);
    }

    .calendar-day.handball-training-day {
      background: var(--emerald-glow);
      border-color: var(--emerald);
    }

    .calendar-day.handball-training-day:hover {
      background: rgba(16, 185, 129, 0.25);
    }

    /* Minimal facilities travel - muted */
    .calendar-day.travel-day.minimal {
      background: rgba(107, 98, 128, 0.15);
      opacity: 0.65;
    }

    .calendar-day.travel-day.minimal:hover {
      background: rgba(107, 98, 128, 0.25);
    }

    /* Gym access travel - teal */
    .calendar-day.travel-day.gym {
      background: rgba(20, 184, 166, 0.15);
    }

    .calendar-day.travel-day.gym:hover {
      background: rgba(20, 184, 166, 0.25);
    }

    /* Default travel-day fallback */
    .calendar-day.travel-day {
      background: rgba(20, 184, 166, 0.1);
      opacity: 0.8;
    }

    .calendar-day.travel-day:hover {
      background: rgba(20, 184, 166, 0.2);
    }

    .travel-badge {
      display: inline-block;
      font-size: 8px;
      background: rgba(20, 184, 166, 0.3);
      color: var(--teal);
      padding: 2px 6px;
      border-radius: var(--radius-full);
      margin-top: 4px;
      font-weight: 500;
    }

    .game-time-note {
      font-size: 10px;
      color: var(--gold);
      margin-top: 4px;
      font-weight: 500;
    }

    .late-game-warning {
      background: rgba(244, 63, 94, 0.15);
      border: 1px solid var(--rose);
      border-radius: var(--radius-sm);
      padding: 10px;
      margin-top: 8px;
      font-size: 11px;
      color: var(--rose);
    }

    .conflict-note {
      font-size: 10px;
      color: var(--teal);
      font-style: italic;
      margin-top: 4px;
    }

    /* Upcoming Workouts */
    .upcoming-section {
      margin-bottom: 20px;
    }

    .upcoming-workout {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .upcoming-workout::after {
      content: '';
      position: absolute;
      right: -20px;
      top: -20px;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0;
      transition: var(--transition);
    }

    .upcoming-workout:hover {
      background: var(--bg-elevated);
      border-color: var(--border-light);
      transform: translateX(4px);
    }

    .upcoming-workout:hover::after {
      opacity: 1;
    }

    .upcoming-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .upcoming-day {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .upcoming-name {
      font-size: 17px;
      font-weight: 600;
      margin-top: 4px;
      color: var(--text-primary);
    }

    .upcoming-badge {
      font-size: 10px;
      background: var(--accent-glow);
      padding: 5px 10px;
      border-radius: var(--radius-full);
      color: var(--accent-light);
      font-weight: 600;
      border: 1px solid var(--accent);
    }

    .upcoming-meta {
      display: flex;
      gap: 14px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .upcoming-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .upcoming-preview {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    /* Workout Preview Modal */
    .preview-modal .workout-preview-content {
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 4px;
    }

    .preview-circuit {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-primary) 100%);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .preview-circuit:hover {
      border-color: var(--border-light);
    }

    .preview-circuit-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-light);
      margin-bottom: 6px;
    }

    .preview-exercises {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* Utility */
    .hidden {
      display: none !important;
    }

    /* Travel Activity Modal */
    .travel-activity-types {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 18px;
    }

    .activity-type-btn {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius-full);
      padding: 10px 18px;
      font-size: 13px;
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .activity-type-btn:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .activity-type-btn.selected {
      border-color: var(--teal);
      background: rgba(20, 184, 166, 0.2);
      color: var(--teal);
      box-shadow: 0 0 12px rgba(20, 184, 166, 0.2);
    }

    .travel-feel-slider {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .travel-feel-btn {
      flex: 1;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      transition: var(--transition);
    }

    .travel-feel-btn:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .travel-feel-btn.selected {
      border-color: var(--teal);
      background: rgba(20, 184, 166, 0.2);
      box-shadow: 0 0 10px rgba(20, 184, 166, 0.2);
    }

    /* Adaptation Banner */
    .adaptation-banner {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.12) 0%, rgba(244, 63, 94, 0.08) 100%);
      border: 1px solid var(--gold);
      border-radius: var(--radius);
      padding: 18px;
      margin: 16px;
      position: relative;
      overflow: hidden;
    }

    .adaptation-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--gold) 0%, var(--rose) 100%);
    }

    .adaptation-banner-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 13px;
      color: var(--gold);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .adaptation-banner-message {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 14px;
      line-height: 1.5;
    }

    .adaptation-banner-action {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .adaptation-banner-action:hover {
      border-color: var(--gold);
      color: var(--gold);
      background: rgba(245, 158, 11, 0.1);
    }

    /* Adjustment Button in Set Modal */
    .adjustment-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: var(--bg-card);
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      margin-bottom: 18px;
      transition: var(--transition);
      font-weight: 500;
    }

    .adjustment-toggle:hover {
      border-color: var(--gold);
      color: var(--gold);
      background: rgba(245, 158, 11, 0.05);
    }

    .adjustment-toggle.active {
      border-style: solid;
      border-color: var(--gold);
      background: rgba(245, 158, 11, 0.12);
      color: var(--gold);
    }

    .adjustment-details {
      display: none;
      margin-bottom: 18px;
      padding: 16px;
      background: rgba(245, 158, 11, 0.05);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }

    .adjustment-details.visible {
      display: block;
      animation: fadeIn 0.2s ease;
    }

    .adjustment-reason-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 14px;
    }

    .reason-chip {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius-full);
      padding: 8px 14px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .reason-chip:hover {
      border-color: var(--border-light);
    }

    .reason-chip.selected {
      border-color: var(--gold);
      background: rgba(245, 158, 11, 0.15);
      color: var(--gold);
    }

    /* History badges */
    .history-badges {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .history-badge {
      font-size: 10px;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-weight: 500;
      border: 1px solid var(--border);
    }

    .history-badge.travel {
      background: rgba(20, 184, 166, 0.15);
      border-color: var(--teal);
      color: var(--teal);
    }

    .history-badge.adjusted {
      background: rgba(245, 158, 11, 0.15);
      border-color: var(--gold);
      color: var(--gold);
    }

    .history-badge.adapted {
      background: rgba(168, 85, 247, 0.15);
      border-color: var(--accent);
      color: var(--accent-light);
    }

    /* External Activity Tiles */
    .activity-tiles {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .activity-tile {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .activity-tile::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--gold) 0%, var(--accent) 100%);
      opacity: 0.6;
    }

    .activity-tile:hover {
      background: var(--bg-elevated);
      border-color: var(--border-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-soft);
    }

    .activity-tile:hover::before {
      opacity: 1;
    }

    .activity-tile.logged {
      border-color: var(--emerald);
      background: linear-gradient(135deg, var(--emerald-glow) 0%, rgba(16, 185, 129, 0.05) 100%);
    }

    .activity-tile.logged::before {
      background: var(--emerald);
      opacity: 1;
    }

    .activity-tile-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .activity-tile-type {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--gold);
      letter-spacing: 1px;
      font-weight: 600;
    }

    .activity-tile-name {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .activity-tile-time {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .activity-tile-status {
      font-size: 11px;
      padding: 6px 12px;
      border-radius: var(--radius-full);
      background: var(--bg-primary);
      color: var(--text-muted);
      font-weight: 500;
      border: 1px solid var(--border);
    }

    .activity-tile-status.logged {
      background: var(--emerald-glow);
      border-color: var(--emerald);
      color: var(--emerald);
    }

    .activity-tile-logged-info {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
      font-size: 13px;
      color: var(--text-secondary);
    }

    .activity-tile-logged-info .rating {
      color: var(--emerald);
      font-weight: 700;
    }

    /* Insights Section */
    .insights-section {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .insights-section::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.4;
    }

    .insights-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      position: relative;
    }

    .insight-card {
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .insight-card:hover {
      border-color: var(--border-light);
    }

    .insight-card:last-child {
      margin-bottom: 0;
    }

    .insight-title {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 0.8px;
      font-weight: 600;
    }

    .insight-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: var(--text-primary);
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }

    .insight-item:last-child {
      border-bottom: none;
    }

    .insight-value {
      color: var(--accent-light);
      font-weight: 700;
    }

    /* ==================== COACH VIEW ==================== */
    #coachView {
      display: none;
      flex-direction: column;
      height: calc(100vh - 140px); /* header + nav */
      position: relative;
    }
    #coachView.active {
      display: flex;
    }

    .coach-settings {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .coach-settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .coach-settings-toggle {
      font-size: 10px;
      transition: transform 0.2s;
    }
    .coach-settings-toggle.collapsed {
      transform: rotate(-90deg);
    }
    .coach-settings-body {
      padding: 0 16px 14px;
    }
    .coach-settings-body.hidden { display: none; }
    .coach-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      display: block;
    }
    .coach-input {
      flex: 1;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      color: var(--text-primary);
      font-size: 14px;
    }
    .coach-save-btn {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }
    .coach-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* Chat messages area */
    .coach-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      -webkit-overflow-scrolling: touch;
    }

    .coach-welcome {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    .coach-welcome-icon { font-size: 48px; margin-bottom: 12px; }
    .coach-welcome-title { font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
    .coach-welcome-text { font-size: 14px; line-height: 1.5; }

    .coach-msg {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 14px;
      line-height: 1.55;
      word-wrap: break-word;
    }
    .coach-msg-user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .coach-msg-assistant {
      align-self: flex-start;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
    }
    .coach-msg-assistant p { margin: 0 0 8px; }
    .coach-msg-assistant p:last-child { margin-bottom: 0; }
    .coach-msg-assistant strong { color: var(--accent-light); }
    .coach-msg-assistant ul, .coach-msg-assistant ol { margin: 4px 0 8px 18px; }
    .coach-msg-assistant li { margin-bottom: 4px; }
    .coach-msg-assistant code {
      background: var(--bg-primary);
      padding: 2px 5px;
      border-radius: 4px;
      font-size: 13px;
    }

    .coach-msg-error {
      align-self: center;
      background: rgba(244, 63, 94, 0.15);
      border: 1px solid var(--rose);
      color: var(--rose);
      font-size: 13px;
      text-align: center;
    }

    /* Typing indicator */
    .coach-typing {
      align-self: flex-start;
      display: flex;
      gap: 5px;
      padding: 14px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      border-bottom-left-radius: 4px;
    }
    .coach-typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
      animation: coachBounce 1.2s infinite;
    }
    .coach-typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .coach-typing-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes coachBounce {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-6px); opacity: 1; }
    }

    /* Quick action chips */
    .coach-chips {
      display: flex;
      gap: 8px;
      padding: 8px 16px;
      overflow-x: auto;
      flex-shrink: 0;
      -webkit-overflow-scrolling: touch;
    }
    .coach-chips::-webkit-scrollbar { display: none; }
    .coach-chip {
      flex-shrink: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--accent-light);
      padding: 8px 14px;
      border-radius: var(--radius-full);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }
    .coach-chip:active {
      background: var(--accent-glow);
      border-color: var(--accent);
    }

    /* Input bar */
    .coach-input-bar {
      display: flex;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    .coach-text-input {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-full);
      padding: 10px 16px;
      color: var(--text-primary);
      font-size: 15px;
      outline: none;
    }
    .coach-text-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }
    .coach-text-input::placeholder { color: var(--text-muted); }
    .coach-send-btn {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: var(--transition);
    }
    .coach-send-btn:active { transform: scale(0.92); }
    .coach-send-btn:disabled { opacity: 0.4; cursor: default; }

  </style>
</head>
<body>
  <!-- Main App -->
  <div id="app">
    <!-- Header -->
    <header>
      <div class="header-top">
        <div>
          <div class="date-display" id="dateDisplay">Saturday, Feb 8</div>
          <div class="day-name" id="dayName">Today's Training</div>
        </div>
        <div class="readiness-badge" onclick="showReadinessModal()">
          <div>
            <div class="readiness-score readiness-high" id="readinessScore">--</div>
            <div class="readiness-label">Readiness</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Today View -->
    <div id="todayView" class="view active">
      <div id="workoutContent">
        <!-- Workout content loaded dynamically -->
      </div>
    </div>

    <!-- History View -->
    <div id="historyView" class="view">
      <div class="history-section">
        <h2 style="margin-bottom: 16px;">Recent Workouts</h2>
        <div id="historyList">
          <!-- History loaded dynamically -->
        </div>
      </div>
    </div>

    <!-- Coach View -->
    <div id="coachView" class="view">
      <!-- Settings (collapsible) -->
      <div class="coach-settings" id="coachSettings">
        <div class="coach-settings-header" onclick="toggleCoachSettings()">
          <span>Coach Setup</span>
          <span class="coach-settings-toggle" id="coachSettingsToggle">&#9660;</span>
        </div>
        <div class="coach-settings-body" id="coachSettingsBody">
          <label class="coach-label">Cloudflare Worker URL</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="coachProxyUrl" class="coach-input" placeholder="https://your-worker.workers.dev">
            <button class="coach-save-btn" onclick="saveCoachSettings()">Save</button>
          </div>
          <p class="coach-hint">Deploy the worker.js proxy, then paste the URL here.</p>
        </div>
      </div>

      <!-- Chat messages -->
      <div class="coach-messages" id="coachMessages">
        <div class="coach-welcome">
          <div class="coach-welcome-icon">&#127947;</div>
          <p class="coach-welcome-title">AI Workout Coach</p>
          <p class="coach-welcome-text">Ask me about today's workout, get adaptations based on your readiness, or plan your next week.</p>
        </div>
      </div>

      <!-- Quick action chips -->
      <div class="coach-chips" id="coachChips">
        <button class="coach-chip" onclick="sendQuickAction('adapt')">Adapt today's workout</button>
        <button class="coach-chip" onclick="sendQuickAction('design')">Design a workout</button>
        <button class="coach-chip" onclick="sendQuickAction('rest')">Should I rest today?</button>
      </div>

      <!-- Input bar -->
      <div class="coach-input-bar">
        <input type="text" id="coachInput" class="coach-text-input" placeholder="Ask your coach..." onkeydown="if(event.key==='Enter')sendCoachMessage()">
        <button class="coach-send-btn" onclick="sendCoachMessage()" id="coachSendBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
        </button>
      </div>
    </div>

    <!-- Plan View -->
    <div id="planView" class="view">
      <div class="plan-section">
        <!-- Week Progress Summary -->
        <div class="week-progress-summary">
          <div class="week-progress-header">
            <span class="week-progress-title">This Week's Progress</span>
            <span class="week-progress-count" id="weekProgressCount">0 / 6 workouts</span>
          </div>
          <div class="week-progress-bar">
            <div class="week-progress-fill" id="weekProgressFill" style="width: 0%"></div>
          </div>
        </div>

        <!-- Workout Plan Calendar -->
        <h2>Workout Plan</h2>
        <div class="calendar-container" id="calendarContainer">
          <!-- Calendar weeks rendered dynamically -->
        </div>

        <!-- Upcoming Workouts -->
        <h2>Upcoming Workouts</h2>
        <div class="upcoming-section" id="upcomingWorkouts">
          <!-- Upcoming workouts rendered dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Rest Timer -->
  <div class="rest-timer" id="restTimer">
    <div class="timer-content">
      <div>
        <div class="timer-label">Rest Time</div>
        <div class="timer-display" id="timerDisplay">1:30</div>
      </div>
      <button class="timer-btn" onclick="skipTimer()">Skip</button>
    </div>
  </div>

  <!-- Set Input Modal -->
  <div class="modal-overlay" id="setModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalExerciseName">Exercise Name</div>
        <button class="modal-close" onclick="closeSetModal()">&times;</button>
      </div>

      <div class="input-group">
        <label class="input-label">Set <span id="modalSetNumber">1</span> of <span id="modalTotalSets">3</span></label>
        <div class="input-row">
          <div class="input-field" id="weightField">
            <input type="number" id="weightInput" inputmode="decimal" placeholder="0">
            <label>Weight (lbs)</label>
          </div>
          <div class="input-field">
            <input type="number" id="repsInput" inputmode="numeric" placeholder="0">
            <label>Reps</label>
          </div>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">How hard was it?</label>
        <div class="feel-slider" id="feelSlider">
          <button class="feel-btn" data-value="1"><span class="number">1</span><span class="label">Easy</span></button>
          <button class="feel-btn" data-value="2"><span class="number">2</span></button>
          <button class="feel-btn" data-value="3"><span class="number">3</span></button>
          <button class="feel-btn" data-value="4"><span class="number">4</span></button>
          <button class="feel-btn" data-value="5"><span class="number">5</span><span class="label">Hard</span></button>
        </div>
      </div>

      <div class="input-group" id="effortTypeGroup">
        <label class="input-label">What made it hard?</label>
        <div class="effort-type-selector" id="effortTypeSelector">
          <button class="effort-type-btn" data-value="physical">
            <span class="type-icon"></span>
            <span class="type-label">Physical</span>
            <span class="type-desc">Strength, cardio, fatigue</span>
          </button>
          <button class="effort-type-btn" data-value="technical">
            <span class="type-icon"></span>
            <span class="type-label">Technical</span>
            <span class="type-desc">Form, coordination, new skill</span>
          </button>
          <button class="effort-type-btn" data-value="both">
            <span class="type-icon"></span>
            <span class="type-label">Both</span>
            <span class="type-desc">Physically & technically demanding</span>
          </button>
        </div>
      </div>

      <div class="adjustment-toggle" id="adjustmentToggle" onclick="showAdjustmentModal()">
        <span>Adjusted from plan?</span>
        <span style="font-size: 11px;">(reduced weight, modified, etc.)</span>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="skipSet()">Skip Set</button>
        <button class="btn btn-success" onclick="logSet()">Log Set</button>
      </div>
    </div>
  </div>

  <!-- Readiness Modal -->
  <div class="modal-overlay" id="readinessModal">
    <div class="modal-content readiness-modal">
      <div class="modal-header">
        <div class="modal-title">Today's Readiness</div>
        <button class="modal-close" onclick="closeReadinessModal()">&times;</button>
      </div>

      <div class="input-group">
        <label class="input-label">Oura Readiness Score</label>
        <div class="input-field">
          <input type="number" id="readinessInput" inputmode="numeric" placeholder="85" min="0" max="100">
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Sleep Score (optional)</label>
        <div class="input-field">
          <input type="number" id="sleepInput" inputmode="numeric" placeholder="80" min="0" max="100">
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">HRV (optional)</label>
        <div class="input-field">
          <input type="number" id="hrvInput" inputmode="numeric" placeholder="45">
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-primary" onclick="saveReadiness()">Save</button>
      </div>
    </div>
  </div>

  <!-- Workout Complete Modal -->
  <div class="modal-overlay" id="completeModal">
    <div class="modal-content complete-modal">
      <h2>Workout Complete!</h2>
      <p id="workoutDuration">45 minutes</p>

      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-value" id="setsCompleted">0</div>
          <div class="stat-label">Sets Completed</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalVolume">0</div>
          <div class="stat-label">Total Volume (lbs)</div>
        </div>
      </div>

      <div class="input-group overall-feel">
        <label class="input-label">Overall difficulty (1 = easy, 10 = max effort)</label>
        <div class="overall-slider" id="overallSlider">
          <button class="overall-btn" data-value="1">1</button>
          <button class="overall-btn" data-value="2">2</button>
          <button class="overall-btn" data-value="3">3</button>
          <button class="overall-btn" data-value="4">4</button>
          <button class="overall-btn" data-value="5">5</button>
          <button class="overall-btn" data-value="6">6</button>
          <button class="overall-btn" data-value="7">7</button>
          <button class="overall-btn" data-value="8">8</button>
          <button class="overall-btn" data-value="9">9</button>
          <button class="overall-btn" data-value="10">10</button>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Main challenge today?</label>
        <div class="effort-type-selector" id="overallEffortType">
          <button class="effort-type-btn" data-value="physical">
            <span class="type-icon"></span>
            <span class="type-label">Physical</span>
          </button>
          <button class="effort-type-btn" data-value="technical">
            <span class="type-icon"></span>
            <span class="type-label">Technical</span>
          </button>
          <button class="effort-type-btn" data-value="mental">
            <span class="type-icon"></span>
            <span class="type-label">Mental</span>
          </button>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Notes (optional)</label>
        <textarea class="notes-input" id="workoutNotes" placeholder="Anything to remember for next time?"></textarea>
      </div>

      <div class="modal-actions">
        <button class="btn btn-success" onclick="saveWorkout()">Save Workout</button>
      </div>
    </div>
  </div>

  <!-- Workout Preview Modal -->
  <div class="modal-overlay" id="previewModal">
    <div class="modal-content preview-modal">
      <div class="modal-header">
        <div class="modal-title" id="previewTitle">Workout Preview</div>
        <button class="modal-close" onclick="closePreviewModal()">&times;</button>
      </div>
      <div id="previewDate" style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;"></div>
      <div id="previewMeta" style="display: flex; gap: 12px; font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;"></div>
      <div class="workout-preview-content" id="previewContent">
        <!-- Preview content rendered dynamically -->
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closePreviewModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Travel Activity Modal -->
  <div class="modal-overlay" id="travelActivityModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Log Travel Activity</div>
        <button class="modal-close" onclick="closeTravelActivityModal()">&times;</button>
      </div>

      <div class="input-group">
        <label class="input-label">Activity Type</label>
        <div class="travel-activity-types" id="travelActivityTypes">
          <button class="activity-type-btn" data-value="hiking">Hiking</button>
          <button class="activity-type-btn" data-value="bodyweight">Bodyweight</button>
          <button class="activity-type-btn" data-value="yoga">Yoga</button>
          <button class="activity-type-btn" data-value="walking">Walking</button>
          <button class="activity-type-btn" data-value="gym">Gym</button>
          <button class="activity-type-btn" data-value="handball">Handball</button>
          <button class="activity-type-btn" data-value="other">Other</button>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Description (optional)</label>
        <input type="text" id="travelActivityDescription" class="notes-input" style="min-height: auto; padding: 12px;" placeholder="e.g., Morning hike in Davis Mountains">
      </div>

      <div class="input-group">
        <label class="input-label">Duration (minutes)</label>
        <div class="input-field">
          <input type="number" id="travelActivityDuration" inputmode="numeric" placeholder="45">
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">How did it feel? (1-5)</label>
        <div class="travel-feel-slider" id="travelFeelSlider">
          <button class="travel-feel-btn" data-value="1">1</button>
          <button class="travel-feel-btn" data-value="2">2</button>
          <button class="travel-feel-btn" data-value="3">3</button>
          <button class="travel-feel-btn" data-value="4">4</button>
          <button class="travel-feel-btn" data-value="5">5</button>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Notes (optional)</label>
        <textarea class="notes-input" id="travelActivityNotes" placeholder="Anything to remember?"></textarea>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeTravelActivityModal()">Cancel</button>
        <button class="btn btn-primary" style="background: #9575cd;" onclick="saveTravelActivity()">Save Activity</button>
      </div>
    </div>
  </div>

  <!-- External Activity Modal -->
  <div class="modal-overlay" id="externalActivityModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="externalActivityTitle">Log Activity</div>
        <button class="modal-close" onclick="closeExternalActivityModal()">&times;</button>
      </div>

      <div class="input-group">
        <label class="input-label">Duration (minutes)</label>
        <div class="input-field">
          <input type="number" id="externalActivityDuration" inputmode="numeric" placeholder="60">
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Intensity (1-10)</label>
        <div class="overall-slider" id="externalIntensitySlider">
          <button class="overall-btn" data-value="1">1</button>
          <button class="overall-btn" data-value="2">2</button>
          <button class="overall-btn" data-value="3">3</button>
          <button class="overall-btn" data-value="4">4</button>
          <button class="overall-btn" data-value="5">5</button>
          <button class="overall-btn" data-value="6">6</button>
          <button class="overall-btn" data-value="7">7</button>
          <button class="overall-btn" data-value="8">8</button>
          <button class="overall-btn" data-value="9">9</button>
          <button class="overall-btn" data-value="10">10</button>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Main focus/challenge?</label>
        <div class="effort-type-selector" id="externalEffortType">
          <button class="effort-type-btn" data-value="physical">
            <span class="type-icon"></span>
            <span class="type-label">Physical</span>
          </button>
          <button class="effort-type-btn" data-value="technical">
            <span class="type-icon"></span>
            <span class="type-label">Technical</span>
          </button>
          <button class="effort-type-btn" data-value="tactical">
            <span class="type-icon"></span>
            <span class="type-label">Tactical</span>
          </button>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">What did you work on? (optional)</label>
        <textarea class="notes-input" id="externalActivityFocus" placeholder="e.g., Focused on defensive positioning, worked on left hand..."></textarea>
      </div>

      <div class="input-group">
        <label class="input-label">Notes for future planning (optional)</label>
        <textarea class="notes-input" id="externalActivityNotes" placeholder="e.g., Need more work on X, felt strong at Y..."></textarea>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeExternalActivityModal()">Cancel</button>
        <button class="btn btn-success" onclick="saveExternalActivity()">Save</button>
      </div>
    </div>
  </div>

  <!-- Adjustment Modal -->
  <div class="modal-overlay" id="adjustmentModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Log Adjustment</div>
        <button class="modal-close" onclick="closeAdjustmentModal()">&times;</button>
      </div>

      <div class="input-group">
        <label class="input-label">What did you adjust?</label>
        <div class="adjustment-reason-chips" id="adjustmentTypeChips">
          <button class="reason-chip" data-value="reduced_weight">Reduced weight</button>
          <button class="reason-chip" data-value="fewer_reps">Fewer reps</button>
          <button class="reason-chip" data-value="skipped_exercise">Skipped exercise</button>
          <button class="reason-chip" data-value="modified_movement">Modified movement</button>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Why? (optional)</label>
        <div class="adjustment-reason-chips" id="adjustmentReasonChips">
          <button class="reason-chip" data-value="fatigue">Fatigue</button>
          <button class="reason-chip" data-value="discomfort">Discomfort</button>
          <button class="reason-chip" data-value="time">Time</button>
          <button class="reason-chip" data-value="form">Form issues</button>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Notes (optional)</label>
        <textarea class="notes-input" id="adjustmentNotes" placeholder="e.g., Left shoulder felt tight from handball yesterday"></textarea>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeAdjustmentModal()">Cancel</button>
        <button class="btn btn-primary" style="background: var(--warning);" onclick="saveAdjustment()">Save Adjustment</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav>
    <div class="nav-item active" onclick="showView('today')">
      <span class="nav-icon"></span>
      <span>Today</span>
    </div>
    <div class="nav-item" onclick="showView('plan')">
      <span class="nav-icon"></span>
      <span>Plan</span>
    </div>
    <div class="nav-item" onclick="showView('history')">
      <span class="nav-icon"></span>
      <span>History</span>
    </div>
    <div class="nav-item" onclick="showView('coach')">
      <span class="nav-icon"></span>
      <span>Coach</span>
    </div>
  </nav>

  <script>
    // ==================== FIREBASE SYNC HELPERS ====================
    // Cache for workout history to avoid repeated reads
    let workoutHistoryCache = null;
    let historyLoaded = false;

    // Get workout history (from cache, localStorage, or Firestore)
    function getWorkoutHistory() {
      if (workoutHistoryCache !== null) {
        return workoutHistoryCache;
      }
      // Fallback to localStorage while Firestore loads
      return JSON.parse(localStorage.getItem('workoutHistory') || '[]');
    }

    // Save workout to history (Firestore + localStorage)
    function saveWorkoutToHistory(workoutData) {
      // Add to local cache
      if (workoutHistoryCache === null) {
        workoutHistoryCache = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
      }
      workoutHistoryCache.unshift(workoutData);
      workoutHistoryCache = workoutHistoryCache.slice(0, 100);

      // Save to localStorage as backup
      localStorage.setItem('workoutHistory', JSON.stringify(workoutHistoryCache));

      // Save to Firestore
      db.collection('workouts').add(workoutData)
        .then(() => console.log('Workout saved to cloud'))
        .catch((error) => console.log('Error saving workout:', error));
    }

    // Load workout history from Firestore (call once on init)
    function loadWorkoutHistoryFromCloud() {
      db.collection('workouts')
        .orderBy('timestamp', 'desc')
        .limit(100)
        .get()
        .then((querySnapshot) => {
          const cloudHistory = [];
          querySnapshot.forEach((doc) => {
            cloudHistory.push(doc.data());
          });

          if (cloudHistory.length > 0) {
            workoutHistoryCache = cloudHistory;
            localStorage.setItem('workoutHistory', JSON.stringify(cloudHistory));
            // Refresh displays
            loadHistory();
            loadPlanView();
          } else {
            // No cloud data, use localStorage
            workoutHistoryCache = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
          }
          historyLoaded = true;
        })
        .catch((error) => {
          console.log('Error loading history from cloud:', error);
          workoutHistoryCache = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
          historyLoaded = true;
        });
    }

    // ==================== DATA ====================
    const WORKOUTS = {
      tuesday: {
        upperBody: {
          name: "Upper Body Focus",
          type: "Strength",
          duration: "45-50 min",
          location: "Gym",
          condition: "Readiness 75+ and Monday game ended early",
          circuits: [
            {
              name: "Circuit A",
              instructions: "Do A1-A2-A3, rest 90 sec, repeat 3x",
              restTime: 90,
              exercises: [
                { id: "a1", name: "Single Arm DB Row", sets: 3, reps: 10, weight: 15, notes: "Each arm. Keep core tight, pull elbow back", perSide: true },
                { id: "a2", name: "Chest Press Machine", sets: 3, reps: 10, weight: 70, notes: "Full range of motion" },
                { id: "a3", name: "Russian Twists w/ Weight", sets: 3, reps: 20, weight: 20, notes: "Tap weight to floor each side" }
              ]
            },
            {
              name: "Circuit B",
              instructions: "Do B1-B2-B3, rest 90 sec, repeat 3x",
              restTime: 90,
              exercises: [
                { id: "b1", name: "Lateral Shoulder Raise", sets: 3, reps: 10, weight: 5, notes: "Raise to shoulder height, controlled" },
                { id: "b2", name: "Lat Pulldown Machine", sets: 3, reps: 10, weight: 55, notes: "Pull to upper chest, squeeze" },
                { id: "b3", name: "Weighted Sit-ups", sets: 3, reps: 12, weight: 5, notes: "Hold weight at chest" }
              ]
            },
            {
              name: "Circuit C",
              instructions: "Do C1-C2, rest 90 sec, repeat 3x",
              restTime: 90,
              exercises: [
                { id: "c1", name: "Bicep Curls", sets: 3, reps: 10, weight: 7.5, notes: "No swinging, control down" },
                { id: "c2", name: "Cable Tricep Extension", sets: 3, reps: 10, weight: 25, notes: "Elbows stay pinned to sides" }
              ]
            }
          ]
        },
        recovery: {
          name: "Post-Late-Game Recovery",
          type: "Recovery",
          duration: "20-25 min",
          location: "Home",
          condition: "Late Monday game (after 9pm) OR readiness 70-75",
          circuits: [
            {
              name: "A. Gentle Warm-Up",
              instructions: "3-4 minutes",
              exercises: [
                { id: "r1", name: "Arm Circles", sets: 1, reps: 20, notes: "10 forward, 10 backward", noWeight: true },
                { id: "r2", name: "Shoulder Shrugs", sets: 1, reps: 15, noWeight: true },
                { id: "r3", name: "Neck Rolls", sets: 1, reps: 10, notes: "5 each direction", noWeight: true },
                { id: "r4", name: "Cross-body Arm Swings", sets: 1, reps: 20, noWeight: true }
              ]
            },
            {
              name: "B. Shoulder Mobility Flow",
              instructions: "5-6 minutes",
              exercises: [
                { id: "r5", name: "Wall Angels", sets: 2, reps: 10, noWeight: true },
                { id: "r6", name: "Thread the Needle", sets: 2, reps: 8, notes: "Each side", perSide: true, noWeight: true },
                { id: "r7", name: "Child's Pose Shoulder Stretch", sets: 1, reps: 1, notes: "Hold 60 seconds", isHold: true, holdTime: 60, noWeight: true }
              ]
            },
            {
              name: "C. Light Shoulder Stability",
              instructions: "8-10 minutes with band",
              exercises: [
                { id: "r8", name: "Band External Rotation", sets: 2, reps: 12, notes: "Each arm, standing", perSide: true, noWeight: true },
                { id: "r9", name: "Band Pull-Aparts", sets: 2, reps: 15, noWeight: true },
                { id: "r10", name: "Scapular Wall Slides", sets: 2, reps: 10, noWeight: true },
                { id: "r11", name: "Band Y-T-W Series", sets: 1, reps: 8, notes: "8 reps each position", noWeight: true }
              ]
            }
          ]
        }
      },
      thursday: {
        bike: {
          name: "Bike Training Week 1",
          type: "Cardio",
          duration: "45 min",
          location: "Outdoor Track",
          circuits: [
            {
              name: "Warm-Up",
              instructions: "15 minutes total",
              exercises: [
                { id: "bw1", name: "Easy Spinning", sets: 1, reps: 1, notes: "5 min easy", isCardio: true, duration: 300 },
                { id: "bw2", name: "Moderate Pace", sets: 1, reps: 1, notes: "5 min moderate", isCardio: true, duration: 300 },
                { id: "bw3", name: "High Cadence Intervals", sets: 2, reps: 1, notes: "1 min at 100+ RPM, 2 min recovery", isCardio: true },
                { id: "bw4", name: "Easy Recovery", sets: 1, reps: 1, notes: "3 min easy", isCardio: true, duration: 180 }
              ]
            },
            {
              name: "Main Set",
              instructions: "20 minutes - Focus on 85-95 RPM",
              exercises: [
                { id: "bm1", name: "Tempo Intervals", sets: 4, reps: 1, notes: "3 min at tempo (comfortably hard), 2 min recovery between. Mental cue: Quick feet, light pressure", isCardio: true, hasRPM: true }
              ]
            },
            {
              name: "Cool-Down",
              instructions: "10 minutes",
              exercises: [
                { id: "bc1", name: "Easy Spinning", sets: 1, reps: 1, notes: "Gradually decrease effort", isCardio: true, duration: 600 }
              ]
            },
            {
              name: "Clipping Practice",
              instructions: "During warm-up and cool-down",
              exercises: [
                { id: "bp1", name: "Clip-in Practice", sets: 1, reps: 20, notes: "Practice smooth clip-ins/outs while rolling", noWeight: true }
              ]
            }
          ]
        }
      },
      friday: {
        lowerBody: {
          name: "Lower Body Focus",
          type: "Strength",
          duration: "45 min",
          location: "Gym",
          condition: "Readiness 80+ and legs feel good",
          circuits: [
            {
              name: "Warm-Up",
              instructions: "5-7 minutes",
              exercises: [
                { id: "fw1", name: "Dynamic Stretches", sets: 1, reps: 1, notes: "BW squats, glute bridges, 30s plank", noWeight: true }
              ]
            },
            {
              name: "Circuit A",
              instructions: "Do A1-A2-A3, rest 90 sec, repeat 3x",
              restTime: 90,
              exercises: [
                { id: "fa1", name: "DB Goblet Squat", sets: 3, reps: 12, weight: 25, notes: "Full depth, chest up" },
                { id: "fa2", name: "Jump Squats", sets: 3, reps: 10, notes: "Explosive, land softly", noWeight: true },
                { id: "fa3", name: "Front Low Plank Hold", sets: 3, reps: 1, notes: "Hold 30 sec, straight line", isHold: true, holdTime: 30, noWeight: true }
              ]
            },
            {
              name: "Circuit B",
              instructions: "Do B1-B2-B3, rest 90 sec, repeat 3x",
              restTime: 90,
              exercises: [
                { id: "fb1", name: "DB Reverse Lunges", sets: 3, reps: 8, weight: 15, notes: "Each leg, knee nearly to floor", perSide: true },
                { id: "fb2", name: "DB RDLs", sets: 3, reps: 10, weight: 15, notes: "Hinge at hips, feel hamstrings" },
                { id: "fb3", name: "Side Plank Hold L+R", sets: 3, reps: 1, notes: "25 sec each side", isHold: true, holdTime: 25, perSide: true, noWeight: true }
              ]
            },
            {
              name: "Circuit C",
              instructions: "Do C1-C2, rest 90 sec, repeat 3x",
              restTime: 90,
              exercises: [
                { id: "fc1", name: "Leg Press Machine", sets: 3, reps: 10, weight: 100, notes: "Full range, control weight" },
                { id: "fc2", name: "Hamstring Curl Machine", sets: 3, reps: 10, weight: 50, notes: "Squeeze at top, slow release" }
              ]
            }
          ]
        }
      },
      saturday: {
        handball: {
          name: "Handball Skill Session",
          type: "Sport-Specific",
          duration: "45-60 min",
          location: "Squash Court / Wall",
          circuits: [
            {
              name: "Dynamic Warm-Up",
              instructions: "8 minutes",
              exercises: [
                { id: "hw1", name: "Light Jog + High Knees + Butt Kicks", sets: 1, reps: 1, notes: "3 min general movement", noWeight: true, isCardio: true },
                { id: "hw2", name: "Arm Circles with Ball", sets: 1, reps: 20, notes: "10 forward, 10 backward", noWeight: true },
                { id: "hw3", name: "Wall Passes Both Hands", sets: 1, reps: 20, notes: "10 each hand at shoulder height", noWeight: true }
              ]
            },
            {
              name: "Jump Shot Technique",
              instructions: "15 minutes - Remember: L-R-LEFT rhythm for right hand",
              exercises: [
                { id: "hj1", name: "Chair Drill", sets: 1, reps: 10, notes: "5 right hand, 5 LEFT hand", noWeight: true },
                { id: "hj2", name: "Wall Target Throws", sets: 3, reps: 12, notes: "6 throws each hand. Alternate 2R, 2L. Rest 60 sec between sets", noWeight: true },
                { id: "hj3", name: "Approach from Angle", sets: 3, reps: 8, notes: "4 throws each side. Rest 60 sec between", noWeight: true }
              ]
            },
            {
              name: "Left Hand Development",
              instructions: "12 minutes - FOCUS BLOCK",
              exercises: [
                { id: "hl1", name: "Distance Progression (Left)", sets: 1, reps: 40, notes: "15 at 2m, 15 at 4m, 10 at 6m", noWeight: true },
                { id: "hl2", name: "Target Practice (Left)", sets: 1, reps: 20, notes: "Hit 4 different targets 5 times each", noWeight: true },
                { id: "hl3", name: "Standing Shot Technique (Left)", sets: 1, reps: 20, notes: "Focus on high elbow, wrist snap", noWeight: true }
              ]
            },
            {
              name: "Conditioning Circuit",
              instructions: "10 minutes - 3 rounds",
              exercises: [
                { id: "hc1", name: "Sprint + Catch + Shoot", sets: 3, reps: 10, notes: "90 sec each round, alternate hands", noWeight: true, isCardio: true },
                { id: "hc2", name: "Defensive Hold + Shot", sets: 3, reps: 6, notes: "60 sec: hold stance, explode to shot every 10 sec", noWeight: true }
              ]
            },
            {
              name: "30 in 3 Finisher",
              instructions: "Track your score!",
              exercises: [
                { id: "hf1", name: "30 in 3", sets: 1, reps: 30, notes: "30 successful throws in 3 minutes - mix of shots", noWeight: true, isCardio: true, trackScore: true }
              ]
            }
          ]
        }
      }
    };

    // ==================== STATE ====================
    let state = {
      currentDate: new Date(),
      readiness: null,
      sleepScore: null,
      hrv: null,
      activeWorkout: null,
      workoutStartTime: null,
      currentExercise: null,
      currentSet: null,
      workoutLog: {},
      timerInterval: null,
      timerSeconds: 0,
      overallFeel: null,
      overallEffortType: null,
      // New state for travel and adjustments
      currentTravelDay: null,
      workoutAdjustments: [],
      pendingWorkout: null
    };

    // ==================== INITIALIZATION ====================
    function init() {
      loadState();
      updateDateDisplay();
      loadTodaysWorkout();
      loadHistory();
      loadPlanView();
      setupEventListeners();

      // Load workout history from cloud (will refresh displays when done)
      loadWorkoutHistoryFromCloud();
    }

    function loadState() {
      // Load from Firestore
      db.collection('userData').doc('dailyState').get()
        .then((doc) => {
          if (doc.exists) {
            const data = doc.data();
            // Check if saved data is from before today's 1am Central reset
            if (data.savedAt && !isAfterTodaysReset(data.savedAt)) {
              // Data is stale, clear it
              state.readiness = null;
              state.sleepScore = null;
              state.hrv = null;
            } else {
              state.readiness = data.readiness || null;
              state.sleepScore = data.sleepScore || null;
              state.hrv = data.hrv || null;
            }
          }
          updateReadinessDisplay();
        })
        .catch((error) => {
          console.log('Error loading state:', error);
          // Fallback to localStorage
          const saved = localStorage.getItem('trainingTrackerState');
          if (saved) {
            const parsed = JSON.parse(saved);
            if (parsed.savedAt && !isAfterTodaysReset(parsed.savedAt)) {
              state.readiness = null;
              state.sleepScore = null;
              state.hrv = null;
            } else {
              state.readiness = parsed.readiness;
              state.sleepScore = parsed.sleepScore;
              state.hrv = parsed.hrv;
            }
          }
          updateReadinessDisplay();
        });
    }

    function isAfterTodaysReset(savedTimestamp) {
      // Reset time is 1am Central
      // Central Time is UTC-6 (CST) or UTC-5 (CDT)
      const now = new Date();
      const savedDate = new Date(savedTimestamp);

      // Get today's 1am Central in local time
      // Create a date for today at 1am Central
      const centralOffset = getCentralOffset();
      const todayReset = new Date();
      todayReset.setHours(1, 0, 0, 0);
      // Adjust for Central time (this assumes user is in Central, which Sophie is)

      // If current time is before 1am, the reset point is yesterday at 1am
      if (now.getHours() < 1) {
        todayReset.setDate(todayReset.getDate() - 1);
      }

      return savedDate >= todayReset;
    }

    function getCentralOffset() {
      // Determine if we're in CDT or CST
      // CDT (daylight) is March-November, CST is November-March
      const now = new Date();
      const jan = new Date(now.getFullYear(), 0, 1);
      const jul = new Date(now.getFullYear(), 6, 1);
      const stdOffset = Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
      const isDST = now.getTimezoneOffset() < stdOffset;
      return isDST ? -5 : -6; // CDT is -5, CST is -6
    }

    function saveState() {
      const stateData = {
        readiness: state.readiness,
        sleepScore: state.sleepScore,
        hrv: state.hrv,
        savedAt: new Date().toISOString()
      };

      // Save to Firestore
      db.collection('userData').doc('dailyState').set(stateData)
        .catch((error) => console.log('Error saving state:', error));

      // Also save to localStorage as backup
      localStorage.setItem('trainingTrackerState', JSON.stringify(stateData));
    }

    function updateDateDisplay() {
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const d = state.currentDate;

      document.getElementById('dateDisplay').textContent =
        `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}`;
    }

    function setupEventListeners() {
      // Feel slider buttons
      document.querySelectorAll('#feelSlider .feel-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#feelSlider .feel-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        });
      });

      // Overall feel slider
      document.querySelectorAll('#overallSlider .overall-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#overallSlider .overall-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          state.overallFeel = parseInt(btn.dataset.value);
        });
      });

      // Effort type selector (per set)
      document.querySelectorAll('#effortTypeSelector .effort-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#effortTypeSelector .effort-type-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        });
      });

      // Overall effort type selector (end of workout)
      document.querySelectorAll('#overallEffortType .effort-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#overallEffortType .effort-type-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          state.overallEffortType = btn.dataset.value;
        });
      });
    }

    // ==================== WORKOUT LOADING ====================
    function loadTodaysWorkout() {
      const dayIndex = state.currentDate.getDay();
      const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
      const dayName = dayNames[dayIndex];
      const dateKey = formatDateKey(state.currentDate);
      const specialDate = SPECIAL_DATES[dateKey];

      // Check if today is a travel day
      if (specialDate && specialDate.type === 'travel') {
        showTravelDay(specialDate);
        return;
      }

      let workout = null;

      // Determine which workout based on day
      switch(dayName) {
        case 'tuesday':
          // Check Monday's game time to determine workout
          const workoutType = getTuesdayWorkoutType(state.currentDate);
          workout = workoutType === 'recovery' ? WORKOUTS.tuesday.recovery : WORKOUTS.tuesday.upperBody;
          break;
        case 'thursday':
          workout = WORKOUTS.thursday.bike;
          break;
        case 'friday':
          workout = WORKOUTS.friday.lowerBody;
          break;
        case 'saturday':
          // Saturday has external activity (soccer) + in-app workout (handball)
          showMixedDay('saturday', WORKOUTS.saturday.handball);
          return;
        default:
          // Show rest day or no workout scheduled
          showNoWorkout(dayName, specialDate);
          return;
      }

      state.activeWorkout = workout;
      state.workoutStartTime = null;
      state.workoutLog = {};
      renderWorkout(workout);
    }

    function showTravelDay(specialDate) {
      const content = document.getElementById('workoutContent');
      const isTransit = specialDate.isTransit;
      const dayLabel = isTransit ? 'Travel Day' : 'Flex Day';
      const typeLabel = isTransit ? 'TRAVEL' : 'FLEX';
      document.getElementById('dayName').textContent = dayLabel;

      // Store current travel info for logging
      state.currentTravelDay = specialDate;

      // Check if already logged activity today
      const dateKey = formatDateKey(state.currentDate);
      const history = getWorkoutHistory();
      const todayLog = history.find(w => w.date === dateKey);
      const hasLogged = todayLog && todayLog.type === 'Travel Activity';

      let optionsList = '';
      if (specialDate.facilities === 'minimal') {
        optionsList = `
          <li>Walking or hiking</li>
          <li>Bodyweight exercises (squats, lunges, push-ups)</li>
          <li>Stretching and mobility work</li>
          <li>Light yoga or movement flow</li>
          <li>Active recovery - enjoy the trip!</li>
        `;
      } else if (specialDate.isTraining) {
        optionsList = `
          <li>Handball clinic drills</li>
          <li>Shooting practice</li>
          <li>Team training</li>
          <li>Tournament games</li>
        `;
      } else {
        optionsList = `
          <li>Gym workout (day pass available)</li>
          <li>Handball skills - find a wall</li>
          <li>Cardio on machines</li>
          <li>Upper or lower body session</li>
          <li>Stretching and mobility</li>
        `;
      }

      const facilityMessage = specialDate.facilities === 'minimal'
        ? isTransit ? 'Travel day - rest up and enjoy the trip!' : 'Facilities are minimal. Focus on rest and enjoying the trip!'
        : specialDate.isTraining
          ? 'Handball training counts as your workout!'
          : `${specialDate.note}`;

      content.innerHTML = `
        <div class="workout-header" style="background: linear-gradient(135deg, rgba(149,117,205,0.3) 0%, var(--bg-secondary) 100%);">
          <div class="workout-type" style="color: #b39ddb;">${typeLabel}</div>
          <div class="workout-title">${specialDate.location}</div>
          <div class="workout-meta">
            <span style="color: #b39ddb;">${specialDate.note}</span>
          </div>
        </div>
        <div style="padding: 20px;">
          <div style="background: var(--bg-secondary); border-radius: var(--radius); padding: 16px; margin-bottom: 16px;">
            <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-primary);">Flex Day Options</h3>
            <ul style="color: var(--text-secondary); font-size: 13px; margin-left: 20px; line-height: 1.8;">
              ${optionsList}
            </ul>
          </div>
          <div style="background: rgba(149,117,205,0.15); border: 1px solid #9575cd; border-radius: var(--radius); padding: 16px; margin-bottom: 16px;">
            <p style="color: var(--text-secondary); font-size: 13px; text-align: center;">
              ${facilityMessage}
            </p>
          </div>
          ${hasLogged ? `
            <div style="background: rgba(78, 205, 196, 0.15); border: 1px solid var(--success); border-radius: var(--radius); padding: 16px; text-align: center;">
              <p style="color: var(--success); font-size: 14px; font-weight: 600;">Activity Logged!</p>
              <p style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">${todayLog.workout}</p>
            </div>
          ` : `
            <button class="btn btn-primary" style="width: 100%; background: #9575cd;" onclick="showTravelActivityModal()">
              Log What You Did
            </button>
          `}
        </div>
      `;
    }

    function showNoWorkout(dayName, specialDate) {
      const content = document.getElementById('workoutContent');

      // Check if this day has external activities
      const activities = EXTERNAL_ACTIVITIES[dayName];

      if (dayName === 'sunday') {
        document.getElementById('dayName').textContent = 'Rest Day';
        content.innerHTML = `
          <div class="workout-header">
            <div class="workout-type">SUNDAY</div>
            <div class="workout-title">Rest Day</div>
            <div class="workout-meta">
              <span>Recover and recharge!</span>
            </div>
          </div>
        `;
        return;
      }

      if (!activities || activities.length === 0) {
        document.getElementById('dayName').textContent = 'No Workout';
        content.innerHTML = `
          <div class="workout-header">
            <div class="workout-type">${dayName.toUpperCase()}</div>
            <div class="workout-title">No scheduled workout</div>
          </div>
        `;
        return;
      }

      // Show external activities as tiles
      const displayDayName = dayName.charAt(0).toUpperCase() + dayName.slice(1);
      document.getElementById('dayName').textContent = displayDayName;

      const dateKey = formatDateKey(state.currentDate);
      const history = getWorkoutHistory();

      // Build activities with any special date info
      let activitiesHtml = '';
      activities.forEach(activity => {
        let activityTime = activity.time;
        let extraInfo = '';

        // For soccer on Monday, get time from SPECIAL_DATES
        if (dayName === 'monday' && activity.id === 'soccer' && specialDate && specialDate.type === 'soccer') {
          activityTime = specialDate.start;
          const gameEndClass = specialDate.isLate ? 'var(--accent-light)' : 'var(--success)';
          extraInfo = `
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
              Ends: <span style="color: ${gameEndClass}; font-weight: 600;">${specialDate.end}</span>
              ${specialDate.isLate ? ' (Late)' : ''}
            </div>
          `;
        }

        // Check if already logged
        const logged = history.find(w =>
          w.date === dateKey &&
          w.type === 'External Activity' &&
          w.activityId === activity.id
        );

        const loggedInfo = logged ? `
          <div class="activity-tile-logged-info">
            <span class="rating">${logged.intensity}/10</span> intensity
            ${logged.duration ? `  ${logged.duration} min` : ''}
            ${logged.effortType ? `  ${logged.effortType}` : ''}
          </div>
        ` : '';

        activitiesHtml += `
          <div class="activity-tile ${logged ? 'logged' : ''}" onclick="openExternalActivityModal('${activity.id}', '${dayName}')">
            <div class="activity-tile-header">
              <div>
                <div class="activity-tile-type">${activity.type}</div>
                <div class="activity-tile-name">${activity.name}</div>
                <div class="activity-tile-time">${activityTime || 'TBD'}  ${activity.location}</div>
                ${extraInfo}
              </div>
              <span class="activity-tile-status ${logged ? 'logged' : ''}">${logged ? 'Logged' : 'Tap to log'}</span>
            </div>
            ${loggedInfo}
          </div>
        `;
      });

      // Add note about tomorrow if Monday late game
      let tomorrowNote = '';
      if (dayName === 'monday' && specialDate && specialDate.type === 'soccer') {
        const noteColor = specialDate.isLate ? 'var(--accent)' : 'var(--success)';
        const noteText = specialDate.isLate
          ? 'Late game tonight  Tomorrow should be Recovery'
          : 'Early game tonight  Tomorrow Upper Body OK if readiness 75+';
        tomorrowNote = `
          <div style="margin: 16px; padding: 12px; background: var(--bg-secondary); border-left: 3px solid ${noteColor}; border-radius: 0 8px 8px 0;">
            <p style="font-size: 13px; color: var(--text-secondary);">${noteText}</p>
          </div>
        `;
      }

      content.innerHTML = `
        <div class="activity-tiles">
          ${activitiesHtml}
        </div>
        ${tomorrowNote}
      `;
    }

    function showMixedDay(dayName, workout) {
      // Days with both external activities AND an in-app workout
      const content = document.getElementById('workoutContent');
      const displayDayName = dayName.charAt(0).toUpperCase() + dayName.slice(1);
      document.getElementById('dayName').textContent = displayDayName;

      const activities = EXTERNAL_ACTIVITIES[dayName] || [];
      const dateKey = formatDateKey(state.currentDate);
      const history = getWorkoutHistory();

      // Build external activity tiles
      let activitiesHtml = '';
      activities.forEach(activity => {
        const logged = history.find(w =>
          w.date === dateKey &&
          w.type === 'External Activity' &&
          w.activityId === activity.id
        );

        const loggedInfo = logged ? `
          <div class="activity-tile-logged-info">
            <span class="rating">${logged.intensity}/10</span> intensity
            ${logged.duration ? `  ${logged.duration} min` : ''}
          </div>
        ` : '';

        activitiesHtml += `
          <div class="activity-tile ${logged ? 'logged' : ''}" onclick="openExternalActivityModal('${activity.id}', '${dayName}')">
            <div class="activity-tile-header">
              <div>
                <div class="activity-tile-type">${activity.type}</div>
                <div class="activity-tile-name">${activity.name}</div>
                <div class="activity-tile-time">${activity.time || 'TBD'}  ${activity.location}</div>
              </div>
              <span class="activity-tile-status ${logged ? 'logged' : ''}">${logged ? 'Logged' : 'Tap to log'}</span>
            </div>
            ${loggedInfo}
          </div>
        `;
      });

      // Check if in-app workout is logged
      const workoutLogged = history.find(w =>
        w.date === dateKey &&
        w.workout === workout.name &&
        w.type !== 'External Activity'
      );

      // Build in-app workout tile
      const workoutLoggedInfo = workoutLogged ? `
        <div class="activity-tile-logged-info">
          <span class="rating">${workoutLogged.overallFeel}/10</span> effort
          ${workoutLogged.duration ? `  ${workoutLogged.duration} min` : ''}
        </div>
      ` : '';

      activitiesHtml += `
        <div class="activity-tile ${workoutLogged ? 'logged' : ''}" onclick="startInAppWorkout()" style="border-color: ${workoutLogged ? 'var(--success)' : 'var(--accent)'};">
          <div class="activity-tile-header">
            <div>
              <div class="activity-tile-type" style="color: var(--accent);">${workout.type}</div>
              <div class="activity-tile-name">${workout.name}</div>
              <div class="activity-tile-time">${workout.duration}  ${workout.location}</div>
            </div>
            <span class="activity-tile-status ${workoutLogged ? 'logged' : ''}" style="${!workoutLogged ? 'background: var(--accent); color: white;' : ''}">${workoutLogged ? 'Logged' : 'Start'}</span>
          </div>
          ${workoutLoggedInfo}
        </div>
      `;

      content.innerHTML = `<div class="activity-tiles">${activitiesHtml}</div>`;

      // Store workout for when they click to start it
      state.pendingWorkout = workout;
    }

    function startInAppWorkout() {
      if (state.pendingWorkout) {
        state.activeWorkout = state.pendingWorkout;
        state.workoutStartTime = null;
        state.workoutLog = {};
        renderWorkout(state.pendingWorkout);
      }
    }

    function renderWorkout(workout) {
      const content = document.getElementById('workoutContent');
      document.getElementById('dayName').textContent = workout.name;

      let html = `
        <div class="workout-header">
          <div class="workout-type">${workout.type}</div>
          <div class="workout-title">${workout.name}</div>
          <div class="workout-meta">
            <span> ${workout.duration}</span>
            <span> ${workout.location}</span>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-label">
            <span>Progress</span>
            <span id="progressText">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>
      `;

      workout.circuits.forEach((circuit, circuitIndex) => {
        html += `
          <div class="circuit-section" id="circuit-${circuitIndex}">
            <div class="circuit-header">
              <div>
                <h3>${circuit.name}</h3>
                <div class="circuit-instructions">${circuit.instructions}</div>
              </div>
              <div class="circuit-status" id="circuit-status-${circuitIndex}">0/${getTotalSets(circuit)}</div>
            </div>
        `;

        circuit.exercises.forEach((exercise, exerciseIndex) => {
          html += renderExercise(exercise, circuitIndex, exerciseIndex, circuit.restTime);
        });

        html += `</div>`;
      });

      html += `
        <div style="padding: 20px;">
          <button class="btn btn-success" style="width: 100%;" onclick="finishWorkout()">
            Finish Workout
          </button>
        </div>
      `;

      content.innerHTML = html;
    }

    function renderExercise(exercise, circuitIndex, exerciseIndex, restTime) {
      const exerciseId = `${circuitIndex}-${exerciseIndex}`;
      const repsText = exercise.isHold ? `${exercise.holdTime}s hold` :
                       exercise.isCardio ? (exercise.duration ? `${Math.floor(exercise.duration/60)}min` : 'Complete') :
                       `${exercise.reps} reps`;

      let html = `
        <div class="exercise-card" id="exercise-${exerciseId}">
          <div class="exercise-top">
            <div>
              <div class="exercise-name">${exercise.name}</div>
              <div class="exercise-target">${exercise.sets} x ${repsText}${exercise.weight ? ` @ ${exercise.weight}+ lbs` : ''}</div>
              ${exercise.notes ? `<div class="exercise-notes">${exercise.notes}</div>` : ''}
            </div>
          </div>
          <div class="sets-container">
      `;

      for (let i = 0; i < exercise.sets; i++) {
        const setId = `${exerciseId}-${i}`;
        html += `
          <div class="set-pill" id="set-${setId}" onclick="openSetModal('${exerciseId}', ${i}, ${JSON.stringify(exercise).replace(/"/g, '&quot;')}, ${restTime || 90})">
            <div class="set-number">Set ${i + 1}</div>
            <div class="set-value" id="set-value-${setId}">--</div>
          </div>
        `;
      }

      html += `
          </div>
        </div>
      `;

      return html;
    }

    function getTotalSets(circuit) {
      return circuit.exercises.reduce((sum, ex) => sum + ex.sets, 0);
    }

    // ==================== SET LOGGING ====================
    function openSetModal(exerciseId, setIndex, exercise, restTime) {
      if (!state.workoutStartTime) {
        state.workoutStartTime = new Date();
      }

      state.currentExercise = { id: exerciseId, data: exercise };
      state.currentSet = setIndex;
      state.currentRestTime = restTime;

      document.getElementById('modalExerciseName').textContent = exercise.name;
      document.getElementById('modalSetNumber').textContent = setIndex + 1;
      document.getElementById('modalTotalSets').textContent = exercise.sets;

      // Show/hide weight field
      const weightField = document.getElementById('weightField');
      if (exercise.noWeight) {
        weightField.style.display = 'none';
      } else {
        weightField.style.display = 'block';
        document.getElementById('weightInput').value = exercise.weight || '';
      }

      // Pre-fill reps
      document.getElementById('repsInput').value = exercise.reps || '';
      document.getElementById('repsInput').placeholder = exercise.isHold ? exercise.holdTime : exercise.reps;

      // Reset feel selection
      document.querySelectorAll('#feelSlider .feel-btn').forEach(b => b.classList.remove('selected'));

      // Reset effort type selection
      document.querySelectorAll('#effortTypeSelector .effort-type-btn').forEach(b => b.classList.remove('selected'));

      document.getElementById('setModal').classList.add('active');
    }

    function closeSetModal() {
      document.getElementById('setModal').classList.remove('active');
    }

    function logSet() {
      const weight = parseFloat(document.getElementById('weightInput').value) || 0;
      const reps = parseInt(document.getElementById('repsInput').value) || state.currentExercise.data.reps;
      const feelBtn = document.querySelector('#feelSlider .feel-btn.selected');
      const feel = feelBtn ? parseInt(feelBtn.dataset.value) : 3;
      const effortTypeBtn = document.querySelector('#effortTypeSelector .effort-type-btn.selected');
      const effortType = effortTypeBtn ? effortTypeBtn.dataset.value : null;

      const setId = `${state.currentExercise.id}-${state.currentSet}`;

      // Save to log
      if (!state.workoutLog[state.currentExercise.id]) {
        state.workoutLog[state.currentExercise.id] = [];
      }
      state.workoutLog[state.currentExercise.id][state.currentSet] = { weight, reps, feel, effortType };

      // Update UI
      const pill = document.getElementById(`set-${setId}`);
      pill.classList.add('complete');

      const valueDisplay = state.currentExercise.data.noWeight ?
        `${reps}` : `${weight}${reps}`;
      document.getElementById(`set-value-${setId}`).textContent = valueDisplay;

      // Update progress
      updateProgress();

      closeSetModal();

      // Start rest timer after completing the last exercise in a circuit round
      // In a circuit (A1-A2-A3, repeat 3x), rest comes after A3 each round, not after each exercise
      const parts = state.currentExercise.id.split('-');
      const circuitIndex = parseInt(parts[0]);
      const exerciseIndex = parseInt(parts[1]);
      const circuit = state.activeWorkout.circuits[circuitIndex];
      const isLastExerciseInCircuit = exerciseIndex === circuit.exercises.length - 1;
      const isLastRound = state.currentSet >= state.currentExercise.data.sets - 1;

      if (isLastExerciseInCircuit && !isLastRound && state.currentRestTime) {
        startRestTimer(state.currentRestTime);
      }
    }

    function skipSet() {
      const setId = `${state.currentExercise.id}-${state.currentSet}`;

      if (!state.workoutLog[state.currentExercise.id]) {
        state.workoutLog[state.currentExercise.id] = [];
      }
      state.workoutLog[state.currentExercise.id][state.currentSet] = { skipped: true };

      const pill = document.getElementById(`set-${setId}`);
      pill.classList.add('skipped');
      document.getElementById(`set-value-${setId}`).textContent = 'Skip';

      updateProgress();
      closeSetModal();
    }

    function updateProgress() {
      let totalSets = 0;
      let completedSets = 0;

      state.activeWorkout.circuits.forEach((circuit, circuitIndex) => {
        let circuitComplete = 0;
        circuit.exercises.forEach((exercise, exerciseIndex) => {
          totalSets += exercise.sets;
          const exerciseId = `${circuitIndex}-${exerciseIndex}`;
          if (state.workoutLog[exerciseId]) {
            const logged = state.workoutLog[exerciseId].filter(s => s && !s.skipped).length;
            completedSets += logged;
            circuitComplete += logged;
          }
        });
        document.getElementById(`circuit-status-${circuitIndex}`).textContent =
          `${circuitComplete}/${getTotalSets(circuit)}`;
      });

      const percent = Math.round((completedSets / totalSets) * 100);
      document.getElementById('progressFill').style.width = `${percent}%`;
      document.getElementById('progressText').textContent = `${percent}%`;
    }

    // ==================== REST TIMER ====================
    function startRestTimer(seconds) {
      // Use wall-clock time so timer stays accurate across tab switches
      state.timerEndTime = Date.now() + (seconds * 1000);
      state.timerDuration = seconds;
      updateTimerDisplay();
      document.getElementById('restTimer').classList.add('active');

      clearInterval(state.timerInterval);
      state.timerInterval = setInterval(() => {
        const remaining = Math.ceil((state.timerEndTime - Date.now()) / 1000);
        if (remaining <= 0) {
          skipTimer();
          // Vibrate if supported
          if (navigator.vibrate) navigator.vibrate(200);
        } else {
          state.timerSeconds = remaining;
          updateTimerDisplay();
        }
      }, 250); // Check 4x/sec for smoother updates after tab switch
    }

    function updateTimerDisplay() {
      const remaining = Math.max(0, Math.ceil((state.timerEndTime - Date.now()) / 1000));
      const mins = Math.floor(remaining / 60);
      const secs = remaining % 60;
      document.getElementById('timerDisplay').textContent =
        `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function skipTimer() {
      clearInterval(state.timerInterval);
      state.timerEndTime = null;
      document.getElementById('restTimer').classList.remove('active');
    }

    // ==================== WORKOUT COMPLETION ====================
    function finishWorkout() {
      const duration = state.workoutStartTime ?
        Math.round((new Date() - state.workoutStartTime) / 60000) : 0;

      let setsCompleted = 0;
      let totalVolume = 0;

      Object.values(state.workoutLog).forEach(sets => {
        sets.forEach(set => {
          if (set && !set.skipped) {
            setsCompleted++;
            totalVolume += (set.weight || 0) * (set.reps || 0);
          }
        });
      });

      document.getElementById('workoutDuration').textContent = `${duration} minutes`;
      document.getElementById('setsCompleted').textContent = setsCompleted;
      document.getElementById('totalVolume').textContent = totalVolume.toLocaleString();

      // Reset selections
      document.querySelectorAll('#overallSlider .overall-btn').forEach(b => b.classList.remove('selected'));
      document.querySelectorAll('#overallEffortType .effort-type-btn').forEach(b => b.classList.remove('selected'));
      document.getElementById('workoutNotes').value = '';
      state.overallFeel = null;
      state.overallEffortType = null;

      document.getElementById('completeModal').classList.add('active');
    }

    function saveWorkout() {
      const workoutData = {
        date: state.currentDate.toISOString().split('T')[0],
        workout: state.activeWorkout.name,
        type: state.activeWorkout.type,
        duration: state.workoutStartTime ?
          Math.round((new Date() - state.workoutStartTime) / 60000) : 0,
        readiness: state.readiness,
        log: state.workoutLog,
        overallFeel: state.overallFeel,
        overallEffortType: state.overallEffortType,
        notes: document.getElementById('workoutNotes').value,
        timestamp: new Date().toISOString(),
        // New fields for adaptation and adjustments
        adjustments: state.workoutAdjustments || [],
        wasAdapted: adaptationApplied !== null,
        adaptationReason: adaptationApplied ? adaptationApplied.message : null
      };

      // Save to Firestore and localStorage
      saveWorkoutToHistory(workoutData);

      document.getElementById('completeModal').classList.remove('active');

      // Reset state
      state.workoutLog = {};
      state.workoutStartTime = null;
      state.overallFeel = null;
      state.overallEffortType = null;
      state.workoutAdjustments = [];
      adaptationApplied = null;
      originalScheduledWorkout = null;

      // Reload workout (shows fresh state)
      loadTodaysWorkout();
      loadHistory();
    }

    // ==================== READINESS ====================
    function showReadinessModal() {
      document.getElementById('readinessInput').value = state.readiness || '';
      document.getElementById('sleepInput').value = state.sleepScore || '';
      document.getElementById('hrvInput').value = state.hrv || '';
      document.getElementById('readinessModal').classList.add('active');
    }

    function closeReadinessModal() {
      document.getElementById('readinessModal').classList.remove('active');
    }

    function saveReadiness() {
      state.readiness = parseInt(document.getElementById('readinessInput').value) || null;
      state.sleepScore = parseInt(document.getElementById('sleepInput').value) || null;
      state.hrv = parseInt(document.getElementById('hrvInput').value) || null;

      updateReadinessDisplay();
      saveState();
      closeReadinessModal();

      // Apply adaptation rules after saving readiness
      applyAdaptationsAndReload();
    }

    function applyAdaptationsAndReload() {
      const metrics = {
        readiness: state.readiness,
        sleepScore: state.sleepScore,
        hrv: state.hrv
      };

      const triggeredRules = applyAdaptationRules(metrics);

      if (triggeredRules.length > 0) {
        const mainRule = triggeredRules[0];

        // Check if we're on a workout day
        const dayIndex = state.currentDate.getDay();
        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const dayName = dayNames[dayIndex];
        const dateKey = formatDateKey(state.currentDate);
        const specialDate = SPECIAL_DATES[dateKey];

        // Only adapt if we have a regular workout scheduled (not travel, not rest)
        if (specialDate && specialDate.type === 'travel') return;
        if (!['tuesday', 'thursday', 'friday', 'saturday'].includes(dayName)) return;

        // Store original workout
        originalScheduledWorkout = state.activeWorkout;

        if (mainRule.action === 'switch_to_rest') {
          // Show rest day with adaptation banner
          adaptationApplied = mainRule;
          showAdaptedRestDay(mainRule);
        } else if (mainRule.action === 'switch_to_recovery') {
          // Switch to recovery workout
          adaptationApplied = mainRule;
          state.activeWorkout = WORKOUTS.tuesday.recovery;
          renderWorkoutWithAdaptation(WORKOUTS.tuesday.recovery, mainRule);
        } else {
          // Just warnings - reload normally but show banner
          loadTodaysWorkout();
          // Insert warning banner after workout header
          setTimeout(() => {
            const header = document.querySelector('.workout-header');
            if (header && triggeredRules.length > 0) {
              const warningBanner = document.createElement('div');
              warningBanner.className = 'adaptation-banner';
              warningBanner.style.margin = '16px';
              warningBanner.innerHTML = `
                <div class="adaptation-banner-header">
                  <span>Note for today</span>
                </div>
                <div class="adaptation-banner-message">
                  ${triggeredRules.map(r => r.message).join('<br>')}
                </div>
              `;
              header.after(warningBanner);
            }
          }, 0);
        }
      }
    }

    function showAdaptedRestDay(rule) {
      const content = document.getElementById('workoutContent');
      document.getElementById('dayName').textContent = 'Rest Day (Adapted)';

      content.innerHTML = `
        ${renderAdaptationBanner([rule], originalScheduledWorkout)}
        <div class="workout-header">
          <div class="workout-type" style="color: var(--warning);">ADAPTED</div>
          <div class="workout-title">Rest Day</div>
          <div class="workout-meta">
            <span>Originally: ${originalScheduledWorkout ? originalScheduledWorkout.name : 'Workout'}</span>
          </div>
        </div>
        <div style="padding: 20px;">
          <div style="background: var(--bg-secondary); border-radius: var(--radius); padding: 20px; text-align: center;">
            <div style="font-size: 32px; margin-bottom: 12px;">Take it easy today</div>
            <p style="color: var(--text-secondary); font-size: 14px;">
              Your body needs recovery. Focus on sleep, hydration, and light movement.
            </p>
          </div>
        </div>
      `;
    }

    function renderWorkoutWithAdaptation(workout, rule) {
      const content = document.getElementById('workoutContent');
      document.getElementById('dayName').textContent = workout.name;

      let html = renderAdaptationBanner([rule], originalScheduledWorkout);

      html += `
        <div class="workout-header">
          <div class="workout-type">${workout.type}</div>
          <div class="workout-title">${workout.name}</div>
          <div class="workout-meta">
            <span> ${workout.duration}</span>
            <span> ${workout.location}</span>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-label">
            <span>Progress</span>
            <span id="progressText">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>
      `;

      workout.circuits.forEach((circuit, circuitIndex) => {
        html += `
          <div class="circuit-section" id="circuit-${circuitIndex}">
            <div class="circuit-header">
              <div>
                <h3>${circuit.name}</h3>
                <div class="circuit-instructions">${circuit.instructions}</div>
              </div>
              <div class="circuit-status" id="circuit-status-${circuitIndex}">0/${getTotalSets(circuit)}</div>
            </div>
        `;

        circuit.exercises.forEach((exercise, exerciseIndex) => {
          html += renderExercise(exercise, circuitIndex, exerciseIndex, circuit.restTime);
        });

        html += `</div>`;
      });

      html += `
        <div style="padding: 20px;">
          <button class="btn btn-success" style="width: 100%;" onclick="finishWorkout()">
            Finish Workout
          </button>
        </div>
      `;

      content.innerHTML = html;
      state.activeWorkout = workout;
    }

    function updateReadinessDisplay() {
      const scoreEl = document.getElementById('readinessScore');
      if (state.readiness) {
        scoreEl.textContent = state.readiness;
        scoreEl.className = 'readiness-score ' +
          (state.readiness >= 80 ? 'readiness-high' :
           state.readiness >= 70 ? 'readiness-mid' : 'readiness-low');
      } else {
        scoreEl.textContent = '--';
        scoreEl.className = 'readiness-score';
      }
    }

    // ==================== NAVIGATION ====================
    function showView(viewName) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

      document.getElementById(`${viewName}View`).classList.add('active');
      document.querySelector(`.nav-item[onclick="showView('${viewName}')"]`).classList.add('active');

      // Update header based on view
      const headerTitles = {
        today: null, // Will be set by loadTodaysWorkout
        plan: 'Workout Plan',
        history: 'History',
        coach: 'Coach'
      };

      if (viewName === 'today') {
        loadTodaysWorkout(); // This sets the appropriate title
      } else {
        document.getElementById('dayName').textContent = headerTitles[viewName];
      }

      // Refresh plan view data when shown
      if (viewName === 'plan') {
        loadPlanView();
      }
    }

    // ==================== HISTORY ====================
    function loadHistory() {
      const history = getWorkoutHistory();
      const container = document.getElementById('historyList');

      if (history.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">No workouts logged yet. Complete your first workout to see it here!</p>';
        return;
      }

      container.innerHTML = history.slice(0, 10).map(workout => {
        const date = new Date(workout.date);
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const effortIcons = { physical: '', technical: '', mental: '', tactical: '' };

        // Build badges
        let badges = '';
        if (workout.type === 'Travel Activity') {
          badges += `<span class="history-badge travel">${workout.activityType || 'Travel'}</span>`;
        }
        if (workout.type === 'External Activity') {
          badges += `<span class="history-badge" style="background: rgba(255, 167, 38, 0.2); color: var(--warning);">${workout.activityType || 'External'}</span>`;
        }
        if (workout.wasAdapted) {
          badges += `<span class="history-badge adapted">Adapted</span>`;
        }
        if (workout.adjustments && workout.adjustments.length > 0) {
          badges += `<span class="history-badge adjusted">${workout.adjustments.length} adjustment${workout.adjustments.length > 1 ? 's' : ''}</span>`;
        }

        // Different display for travel activities
        if (workout.type === 'Travel Activity') {
          return `
            <div class="history-day" style="border-left: 3px solid #9575cd;">
              <div class="history-date">${days[date.getDay()]}, ${date.toLocaleDateString()}</div>
              <div class="history-workout">${workout.workout}</div>
              <div class="history-stats">
                ${workout.duration ? `<span> ${workout.duration} min</span>` : ''}
                ${workout.location ? `<span> ${workout.location}</span>` : ''}
                ${workout.overallFeel ? `<span>Feel: ${workout.overallFeel}/5</span>` : ''}
              </div>
              ${badges ? `<div class="history-badges">${badges}</div>` : ''}
              ${workout.notes ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; font-style: italic;">"${workout.notes}"</div>` : ''}
            </div>
          `;
        }

        // Different display for external activities
        if (workout.type === 'External Activity') {
          const effortIcon = effortIcons[workout.effortType] || '';
          return `
            <div class="history-day" style="border-left: 3px solid var(--warning);">
              <div class="history-date">${days[date.getDay()]}, ${date.toLocaleDateString()}</div>
              <div class="history-workout">${workout.workout}</div>
              <div class="history-stats">
                ${workout.duration ? `<span> ${workout.duration} min</span>` : ''}
                ${workout.location ? `<span> ${workout.location}</span>` : ''}
                ${workout.intensity ? `<span>Intensity: ${workout.intensity}/10</span>` : ''}
                ${workout.effortType ? `<span>${effortIcon} ${workout.effortType}</span>` : ''}
              </div>
              ${badges ? `<div class="history-badges">${badges}</div>` : ''}
              ${workout.focus ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;"><strong>Focus:</strong> ${workout.focus}</div>` : ''}
              ${workout.notes ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; font-style: italic;">"${workout.notes}"</div>` : ''}
            </div>
          `;
        }

        return `
          <div class="history-day">
            <div class="history-date">${days[date.getDay()]}, ${date.toLocaleDateString()}</div>
            <div class="history-workout">${workout.workout}</div>
            <div class="history-stats">
              <span> ${workout.duration} min</span>
              ${workout.readiness ? `<span> ${workout.readiness}</span>` : ''}
              ${workout.overallFeel ? `<span>Effort: ${workout.overallFeel}/10</span>` : ''}
              ${workout.overallEffortType ? `<span>${effortIcons[workout.overallEffortType]} ${workout.overallEffortType}</span>` : ''}
            </div>
            ${badges ? `<div class="history-badges">${badges}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // ==================== PLAN VIEW ====================

    // External activities by day (activities not fully tracked in-app but worth logging)
    const EXTERNAL_ACTIVITIES = {
      monday: [
        {
          id: 'personal_training',
          name: 'Personal Training',
          time: '4:00pm',
          duration: 60,
          location: 'Gym',
          type: 'Strength',
          description: 'Trainer-led session'
        },
        {
          id: 'soccer',
          name: 'Soccer',
          time: null, // Set from SPECIAL_DATES
          duration: 90,
          location: 'Field',
          type: 'Sport',
          description: 'League game'
        }
      ],
      wednesday: [
        {
          id: 'handball_practice',
          name: 'Handball Practice',
          time: '7:00pm',
          duration: 120,
          location: 'Court',
          type: 'Sport',
          description: 'Team practice'
        }
      ],
      saturday: [
        {
          id: 'soccer_pickup',
          name: 'Soccer',
          time: '2:00pm',
          duration: 60,
          location: 'Field',
          type: 'Sport',
          description: 'Pickup game'
        }
      ]
    };

    const SCHEDULE = {
      // Day of week (0=Sun, 1=Mon, etc) -> workout info
      0: { type: 'rest', name: 'Rest Day', external: false },
      1: { type: 'external', name: 'Personal Training (4pm) + Soccer', external: true, duration: 'Varies', location: 'Gym + Field' },
      2: { type: 'gym', name: 'Upper Body OR Recovery', workout: 'tuesday', duration: '45-50 min', location: 'Gym/Home', preview: 'Rows, Chest Press, Shoulder Work, Core' },
      3: { type: 'external', name: 'Handball Practice (7-9pm)', external: true, duration: '90 min', location: 'Court' },
      4: { type: 'cardio', name: 'Bike + Shoulder Protocol', workout: 'thursday', duration: '45 min', location: 'Outdoor Track', preview: 'Tempo Intervals, Cadence Work, Clip Practice' },
      5: { type: 'gym', name: 'Lower Body + Yoga (6:30pm)', workout: 'friday', duration: '45 min', location: 'Gym', preview: 'Squats, Lunges, RDLs, Core Stability' },
      6: { type: 'sport', name: 'Soccer (2-3pm) + Handball Skills', workout: 'saturday', duration: '45-60 min', location: 'Field + Court', preview: 'Jump Shots, Left Hand Work, Conditioning' }
    };

    // Special dates with specific schedule info
    const SPECIAL_DATES = {
      // Monday soccer game times (format: 'YYYY-MM-DD': { start, end, isLate })
      // isLate = ends after 9pm, affects next day's workout choice
      '2026-02-09': { type: 'soccer', start: '7:40pm', end: '9:15pm', isLate: false, note: 'Early game - Tuesday can do Upper Body if readiness OK' },
      '2026-02-23': { type: 'soccer', start: '8:45pm', end: '10:20pm', isLate: true, note: 'Late game - Tuesday should do Recovery' },
      '2026-03-02': { type: 'soccer', start: '9:15pm', end: '10:50pm', isLate: true, note: 'Late game (outside 3-week plan)' },

      // Fort Davis Trip (Feb 12-15) - minimal facilities
      '2026-02-12': { type: 'travel', location: 'Fort Davis, TX', note: 'Travel day', facilities: 'minimal', isTransit: true },
      '2026-02-13': { type: 'travel', location: 'Fort Davis, TX', note: 'Minimal facilities', facilities: 'minimal' },
      '2026-02-14': { type: 'travel', location: 'Fort Davis, TX', note: 'Active recovery', facilities: 'minimal' },
      '2026-02-15': { type: 'travel', location: 'Fort Davis, TX', note: 'Travel back to Houston', facilities: 'minimal', isTransit: true },

      // NC Handball Trip (Feb 20-22)
      '2026-02-20': { type: 'travel', location: 'NC', note: 'Hotel gym available - stay light before big weekend', facilities: 'gym' },
      '2026-02-21': { type: 'travel', location: 'NC', note: 'Handball Clinic/Tournament', facilities: 'handball', isTraining: true },
      '2026-02-22': { type: 'travel', location: 'NC', note: 'Carolina Blue Cup - Competition!', facilities: 'handball', isTraining: true },

      // Kyle, TX Trip (Feb 27 - Mar 1) - gym day pass available
      '2026-02-27': { type: 'travel', location: 'Kyle, TX', note: 'Gym day pass available', facilities: 'gym' },
      '2026-02-28': { type: 'travel', location: 'Kyle, TX', note: 'Find wall for handball', facilities: 'gym+wall' },
      '2026-03-01': { type: 'travel', location: 'Kyle, TX', note: 'Rest or active recovery', facilities: 'gym' }
    };

    // Helper to check if a date is a travel day
    function isTravelDay(date) {
      const dateStr = formatDateKey(date);
      const special = SPECIAL_DATES[dateStr];
      return special && special.type === 'travel';
    }

    // Helper to format date as YYYY-MM-DD
    function formatDateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Helper to get previous Monday's game info for a Tuesday
    function getPreviousMondayGameInfo(tuesdayDate) {
      const monday = new Date(tuesdayDate);
      monday.setDate(monday.getDate() - 1);
      const mondayKey = formatDateKey(monday);
      return SPECIAL_DATES[mondayKey];
    }

    // Determine Tuesday workout based on Monday's game
    function getTuesdayWorkoutType(date) {
      const mondayGame = getPreviousMondayGameInfo(date);
      if (mondayGame && mondayGame.type === 'soccer' && mondayGame.isLate) {
        return 'recovery';
      }
      return 'upperBody';
    }

    // 3-week plan: Monday-Sunday, starting Feb 9, 2026
    const WEEK_DATES = [
      { weekNum: 1, start: new Date(2026, 1, 9), end: new Date(2026, 1, 15) },   // Feb 9-15
      { weekNum: 2, start: new Date(2026, 1, 16), end: new Date(2026, 1, 22) },  // Feb 16-22
      { weekNum: 3, start: new Date(2026, 1, 23), end: new Date(2026, 2, 1) }    // Feb 23 - Mar 1
    ];

    function loadPlanView() {
      renderCalendar();
      renderUpcomingWorkouts();
      updateWeekProgress();
      renderInsights();
    }

    function renderInsights() {
      const container = document.querySelector('.plan-section');
      const existingInsights = document.querySelector('.insights-section');
      if (existingInsights) {
        existingInsights.remove();
      }

      const insightsHtml = renderInsightsSection();
      if (insightsHtml) {
        // Insert after week progress summary
        const weekProgress = document.querySelector('.week-progress-summary');
        if (weekProgress) {
          weekProgress.insertAdjacentHTML('afterend', insightsHtml);
        }
      }
    }

    function renderCalendar() {
      const container = document.getElementById('calendarContainer');
      const today = state.currentDate;
      const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
      const months = ['Jan', 'Feb', 'Mar'];

      let html = '';

      WEEK_DATES.forEach((week, weekIndex) => {
        const isCurrentWeek = today >= week.start && today <= week.end;
        const startMonth = months[week.start.getMonth()];
        const endMonth = months[week.end.getMonth()];
        const dateRange = startMonth === endMonth
          ? `${startMonth} ${week.start.getDate()}-${week.end.getDate()}`
          : `${startMonth} ${week.start.getDate()} - ${endMonth} ${week.end.getDate()}`;

        html += `
          <div class="calendar-week ${isCurrentWeek ? 'current-week' : ''}">
            <div class="calendar-week-label">
              <span>Week ${week.weekNum}${isCurrentWeek ? ' (Current)' : ''}</span>
              <span class="week-dates">${dateRange}</span>
            </div>
            <div class="calendar-days">
        `;

        // Generate 7 days for this week
        for (let i = 0; i < 7; i++) {
          const dayDate = new Date(week.start);
          dayDate.setDate(week.start.getDate() + i);
          const dayOfWeek = dayDate.getDay();
          const dateKey = formatDateKey(dayDate);
          const specialDate = SPECIAL_DATES[dateKey];
          const isTravel = specialDate && specialDate.type === 'travel';
          const schedule = SCHEDULE[dayOfWeek];

          const isToday = dayDate.toDateString() === today.toDateString();
          const isPast = dayDate < today && !isToday;

          let workoutClass = '';
          let workoutDisplay = '';
          let extraClasses = '';

          if (isTravel) {
            const facilities = specialDate.facilities;
            const isHandballTraining = specialDate.isTraining;
            if (isHandballTraining) {
              workoutClass = 'handball-training';
              extraClasses = 'handball-training-day';
              workoutDisplay = 'Handball';
            } else if (facilities === 'minimal') {
              workoutClass = 'travel';
              extraClasses = 'travel-day minimal';
              workoutDisplay = 'Flex';
            } else {
              workoutClass = 'travel';
              extraClasses = 'travel-day gym';
              workoutDisplay = 'GYM';
            }
          } else if (schedule.type === 'rest') {
            workoutClass = 'rest';
            workoutDisplay = 'Rest';
          } else if (schedule.external) {
            workoutClass = 'external';
            workoutDisplay = getShortWorkoutName(schedule, dayDate);
          } else {
            workoutDisplay = getShortWorkoutName(schedule, dayDate);
          }

          html += `
            <div class="calendar-day ${isToday ? 'today' : ''} ${isPast ? 'past' : ''} ${extraClasses}"
                 onclick="showDayPreview(${dayDate.getTime()}, ${dayOfWeek})">
              <div class="calendar-day-name">${dayNames[dayOfWeek]}</div>
              <div class="calendar-day-number">${dayDate.getDate()}</div>
              <div class="calendar-day-workout ${workoutClass}">${workoutDisplay}</div>
            </div>
          `;
        }

        html += `
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function getShortWorkoutName(schedule, date) {
      switch(schedule.type) {
        case 'rest': return 'Rest';
        case 'external':
          if (schedule.name.includes('Personal')) return 'PT+Soccer';
          if (schedule.name.includes('Handball Practice')) return 'Handball';
          return schedule.name;
        case 'gym':
          if (schedule.name.includes('Upper')) {
            // For Tuesday, check Monday's game time
            if (date) {
              const workoutType = getTuesdayWorkoutType(date);
              return workoutType === 'recovery' ? 'Recovery' : 'Upper';
            }
            return 'Upper';
          }
          if (schedule.name.includes('Lower')) return 'Lower';
          return schedule.name;
        case 'cardio': return 'Bike';
        case 'sport': return 'Soccer+HB';
        default: return schedule.name;
      }
    }

    function renderUpcomingWorkouts() {
      const container = document.getElementById('upcomingWorkouts');
      const today = state.currentDate;
      const upcoming = [];
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const months = ['Jan', 'Feb', 'Mar'];

      // Find next 5 workout days (skip today, include external)
      let checkDate = new Date(today);
      checkDate.setDate(checkDate.getDate() + 1); // Start from tomorrow

      while (upcoming.length < 5) {
        const dayOfWeek = checkDate.getDay();
        const schedule = SCHEDULE[dayOfWeek];
        const dateKey = formatDateKey(checkDate);
        const specialDate = SPECIAL_DATES[dateKey];

        if (schedule.type !== 'rest') {
          upcoming.push({
            date: new Date(checkDate),
            dayOfWeek,
            schedule,
            specialDate,
            isTravel: specialDate && specialDate.type === 'travel'
          });
        }

        checkDate.setDate(checkDate.getDate() + 1);

        // Safety: don't go past our plan window
        if (checkDate > WEEK_DATES[WEEK_DATES.length - 1].end) break;
      }

      let html = '';
      upcoming.forEach(item => {
        const dateStr = `${dayNames[item.date.getDay()]}, ${months[item.date.getMonth()]} ${item.date.getDate()}`;
        const schedule = item.schedule;
        const dateKey = formatDateKey(item.date);

        // Determine display name and extra info
        let displayName = schedule.name;
        let extraInfo = '';
        let badgeText = schedule.type === 'external' ? 'External' : schedule.type;
        let previewText = schedule.preview || '';

        // Handle travel days - different types based on facilities
        if (item.isTravel) {
          const facilities = item.specialDate.facilities;
          const isHandballTraining = item.specialDate.isTraining;

          if (isHandballTraining) {
            // NC Handball Trip - this IS the training!
            badgeText = 'HANDBALL';
            displayName = item.specialDate.note;
            previewText = `${item.specialDate.location} - Handball training counts as workout!`;
            extraInfo = item.specialDate.note.includes('Competition')
              ? `<div class="game-time-note">Playing with new team - Carolina Blue Cup!</div>`
              : '';
          } else if (facilities === 'minimal') {
            // Fort Davis - minimal facilities, flex day
            badgeText = 'FLEX';
            displayName = 'Flex Day';
            previewText = `${item.specialDate.location} - ${item.specialDate.note}`;
            extraInfo = '';
          } else if (facilities === 'gym' || facilities === 'gym+wall') {
            // Kyle - gym access available
            badgeText = 'FLEX';
            displayName = facilities === 'gym+wall' ? 'Handball Skills (Find Wall)' : 'Gym Workout Available';
            previewText = `${item.specialDate.location} - ${item.specialDate.note}`;
            extraInfo = `<div class="game-time-note">Gym day pass available</div>`;
          } else {
            badgeText = item.specialDate.isTransit ? 'TRAVEL' : 'FLEX';
            previewText = `${item.specialDate.location} - ${item.specialDate.note}`;
          }
        }

        // Handle Monday with soccer game times
        if (item.dayOfWeek === 1 && item.specialDate && item.specialDate.type === 'soccer') {
          const game = item.specialDate;
          displayName = `Personal Training (4pm) + Soccer (${game.start})`;
          if (game.isLate) {
            extraInfo += `<div class="late-game-warning">Late game (ends ${game.end}) - Tomorrow should be Recovery day</div>`;
          } else {
            extraInfo += `<div class="game-time-note">Early game ends ${game.end} - Tomorrow Upper Body OK if rested</div>`;
          }
        }

        // Handle Tuesday - show appropriate workout based on Monday
        if (item.dayOfWeek === 2) {
          const workoutType = getTuesdayWorkoutType(item.date);
          const mondayGame = getPreviousMondayGameInfo(item.date);

          if (workoutType === 'recovery') {
            displayName = 'Post-Late-Game Recovery';
            previewText = 'Gentle warm-up, Shoulder mobility, Light stability work';
            badgeText = 'Recovery';
            if (mondayGame) {
              extraInfo = `<div class="late-game-warning">Monday game ended at ${mondayGame.end} - Recovery recommended</div>`;
            }
          } else {
            displayName = 'Upper Body Focus';
            previewText = 'Rows, Chest Press, Shoulder Work, Core';
            if (mondayGame && !mondayGame.isLate) {
              extraInfo = `<div class="game-time-note">Monday game ended ${mondayGame.end} - Upper Body OK if readiness 75+</div>`;
            }
          }
        }

        // Determine badge styling based on travel type
        let badgeStyle = '';
        let travelClass = '';
        if (item.isTravel) {
          const isHandballTraining = item.specialDate.isTraining;
          const facilities = item.specialDate.facilities;
          if (isHandballTraining) {
            badgeStyle = 'style="background: rgba(76, 175, 80, 0.3); color: #81c784;"'; // Green for training
            travelClass = 'handball-training';
          } else if (facilities === 'minimal') {
            badgeStyle = 'style="background: rgba(158, 158, 158, 0.3); color: #bdbdbd;"'; // Gray for rest
            travelClass = 'travel-day minimal';
          } else {
            badgeStyle = 'style="background: rgba(149, 117, 205, 0.3); color: #b39ddb;"'; // Purple for gym travel
            travelClass = 'travel-day gym-access';
          }
        }

        html += `
          <div class="upcoming-workout ${item.isTravel ? travelClass : ''}" onclick="showDayPreview(${item.date.getTime()}, ${item.dayOfWeek})">
            <div class="upcoming-header">
              <div>
                <div class="upcoming-day">${dateStr}</div>
                <div class="upcoming-name">${displayName}</div>
              </div>
              <span class="upcoming-badge" ${badgeStyle}>${badgeText}</span>
            </div>
            <div class="upcoming-meta">
              ${schedule.duration && !item.isTravel ? `<span> ${schedule.duration}</span>` : ''}
              ${schedule.location && !item.isTravel ? `<span> ${schedule.location}</span>` : ''}
              ${item.isTravel ? `<span> ${item.specialDate.location}</span>` : ''}
            </div>
            ${previewText ? `<div class="upcoming-preview">${previewText}</div>` : ''}
            ${extraInfo}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function updateWeekProgress() {
      const today = state.currentDate;
      const history = getWorkoutHistory();

      // Find current week
      const currentWeek = WEEK_DATES.find(w => today >= w.start && today <= w.end);
      if (!currentWeek) return;

      // Count planned workouts for this week
      // Each external activity counts separately (e.g. Monday PT + soccer = 2)
      // In-app workouts count as 1 per day
      let plannedCount = 0;
      const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];

      for (let i = 0; i < 7; i++) {
        const dayDate = new Date(currentWeek.start);
        dayDate.setDate(currentWeek.start.getDate() + i);
        const dayOfWeek = dayDate.getDay();
        const schedule = SCHEDULE[dayOfWeek];
        const dateKey = formatDateKey(dayDate);
        const specialDate = SPECIAL_DATES[dateKey];
        const isTravel = specialDate && specialDate.type === 'travel';
        const dayName = dayNames[dayOfWeek];

        if (schedule.type === 'rest') continue;

        if (isTravel) {
          if (specialDate.facilities === 'minimal') continue;
          // Handball training or gym access counts as 1
          plannedCount++;
          continue;
        }

        // Count external activities for this day
        const externalActivities = EXTERNAL_ACTIVITIES[dayName] || [];
        plannedCount += externalActivities.length;

        // Count in-app workout if this day has one
        if (schedule.workout) {
          plannedCount++;
        }
      }

      // Count completed workouts this week (every logged entry counts)
      let completedCount = 0;
      history.forEach(workout => {
        const workoutDate = new Date(workout.date);
        if (workoutDate >= currentWeek.start && workoutDate <= currentWeek.end) {
          completedCount++;
        }
      });

      // Cap progress bar at 100% (ad-hoc workouts can push above planned)
      const percent = plannedCount > 0 ? Math.min(100, Math.round((completedCount / plannedCount) * 100)) : 0;

      document.getElementById('weekProgressCount').textContent = `${completedCount} / ${plannedCount} workouts`;
      document.getElementById('weekProgressFill').style.width = `${percent}%`;
    }

    function showDayPreview(timestamp, dayOfWeek) {
      const date = new Date(timestamp);
      const dateKey = formatDateKey(date);

      // If clicking on today, navigate to Today tab instead of showing preview
      const today = state.currentDate;
      const isToday = date.getDate() === today.getDate() &&
                      date.getMonth() === today.getMonth() &&
                      date.getFullYear() === today.getFullYear();
      if (isToday) {
        showView('today');
        return;
      }

      const specialDate = SPECIAL_DATES[dateKey];
      const isTravel = specialDate && specialDate.type === 'travel';
      const schedule = SCHEDULE[dayOfWeek];
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const months = ['January', 'February', 'March'];

      let previewTitle = schedule.name;
      let metaHtml = '';
      let contentHtml = '';

      // Handle travel days - with different types
      if (isTravel) {
        const facilities = specialDate.facilities;
        const isHandballTraining = specialDate.isTraining;

        document.getElementById('previewDate').textContent = `${dayNames[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}, 2026`;
        metaHtml = `<span> ${specialDate.location}</span>`;
        document.getElementById('previewMeta').innerHTML = metaHtml;

        if (isHandballTraining) {
          // NC Handball Trip - this IS training!
          previewTitle = specialDate.note;
          document.getElementById('previewTitle').textContent = previewTitle;
          contentHtml = `
            <div style="padding: 16px; background: rgba(76, 175, 80, 0.15); border-radius: 8px; border: 1px solid #4caf50;">
              <div style="color: #81c784; font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Handball Training Trip</div>
              <p style="color: var(--text-primary); font-size: 14px; margin-bottom: 12px;">${specialDate.note}</p>
              <p style="color: var(--text-secondary); font-size: 12px;">This counts as your workout for the day!</p>
            </div>
            ${specialDate.note.includes('Competition') ? `
            <div style="margin-top: 12px; padding: 12px; background: rgba(255, 193, 7, 0.15); border-radius: 8px; border: 1px solid #ffc107;">
              <div style="color: #ffd54f; font-size: 11px; text-transform: uppercase; margin-bottom: 6px;">Competition Day</div>
              <p style="color: var(--text-secondary); font-size: 12px;">Playing with your new team - Carolina Blue Cup!</p>
            </div>` : ''}
          `;
        } else if (facilities === 'minimal') {
          // Fort Davis - flex day
          previewTitle = 'Flex Day';
          document.getElementById('previewTitle').textContent = previewTitle;
          contentHtml = `
            <div style="padding: 16px; background: rgba(158, 158, 158, 0.15); border-radius: 8px; border: 1px solid #9e9e9e;">
              <div style="color: #bdbdbd; font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Flex Day</div>
              <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">${specialDate.note}</p>
              <p style="color: var(--text-secondary); font-size: 12px;">Facilities: Minimal - see what's available</p>
            </div>
            <div style="margin-top: 12px; padding: 12px; background: var(--bg-card); border-radius: 8px;">
              <div style="color: var(--accent); font-size: 11px; text-transform: uppercase; margin-bottom: 6px;">Options to Explore</div>
              <ul style="color: var(--text-secondary); font-size: 12px; margin-left: 16px;">
                <li>Walking/hiking</li>
                <li>Bodyweight exercises</li>
                <li>Stretching & mobility</li>
                <li>Rest if needed</li>
              </ul>
            </div>
          `;
        } else {
          // Kyle - gym available
          previewTitle = 'Flex Day (Gym Access)';
          document.getElementById('previewTitle').textContent = previewTitle;
          contentHtml = `
            <div style="padding: 16px; background: rgba(149, 117, 205, 0.15); border-radius: 8px; border: 1px solid #9575cd;">
              <div style="color: #b39ddb; font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Flex Day - Gym Access</div>
              <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">${specialDate.note}</p>
              <p style="color: var(--text-secondary); font-size: 12px;">Facilities: ${facilities}</p>
            </div>
            <div style="margin-top: 12px; padding: 12px; background: var(--bg-card); border-radius: 8px;">
              <div style="color: var(--success); font-size: 11px; text-transform: uppercase; margin-bottom: 6px;">Suggested Workouts</div>
              <ul style="color: var(--text-secondary); font-size: 12px; margin-left: 16px;">
                <li>Full gym workout (day pass)</li>
                ${facilities.includes('wall') ? '<li>Handball skills - find a wall!</li>' : ''}
                <li>Cardio on machines</li>
                <li>Upper or lower body session</li>
              </ul>
            </div>
          `;
        }

        document.getElementById('previewContent').innerHTML = contentHtml;
        document.getElementById('previewModal').classList.add('active');
        return;
      }

      // Handle Monday with soccer game info
      if (dayOfWeek === 1 && specialDate && specialDate.type === 'soccer') {
        previewTitle = `Personal Training (4pm) + Soccer`;
        document.getElementById('previewTitle').textContent = previewTitle;
        document.getElementById('previewDate').textContent = `${dayNames[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}, 2026`;

        metaHtml = `<span> PT: 1hr + Soccer: 90min</span><span> Gym + Field</span>`;
        document.getElementById('previewMeta').innerHTML = metaHtml;

        const game = specialDate;
        const gameTimeClass = game.isLate ? 'style="color: var(--accent);"' : 'style="color: var(--success);"';

        contentHtml = `
          <div style="padding: 16px; background: var(--bg-card); border-radius: 8px; margin-bottom: 12px;">
            <div style="color: var(--warning); font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Today's Schedule</div>
            <div style="color: var(--text-primary); font-size: 14px; margin-bottom: 8px;">
              <strong>4:00pm</strong> - Personal Training (Gym)<br>
              <strong ${gameTimeClass}>${game.start}</strong> - Soccer Game
            </div>
            <div style="color: var(--text-secondary); font-size: 12px;">
              Game ends: <span ${gameTimeClass}>${game.end}</span>
              ${game.isLate ? ' (Late game)' : ' (Early game)'}
            </div>
          </div>
          <div style="padding: 12px; background: ${game.isLate ? 'rgba(233,69,96,0.15)' : 'rgba(78,205,196,0.15)'}; border-radius: 8px; border: 1px solid ${game.isLate ? 'var(--accent)' : 'var(--success)'};">
            <div style="color: ${game.isLate ? 'var(--accent-light)' : 'var(--success)'}; font-size: 11px; text-transform: uppercase; margin-bottom: 6px;">Tomorrow's Recommendation</div>
            <p style="color: var(--text-secondary); font-size: 13px;">
              ${game.isLate
                ? 'Late game - Tomorrow should be <strong>Recovery workout</strong> (shoulder mobility, light stability)'
                : 'Early game - Tomorrow can be <strong>Upper Body</strong> workout if readiness 75+'}
            </p>
          </div>
        `;

        document.getElementById('previewContent').innerHTML = contentHtml;
        document.getElementById('previewModal').classList.add('active');
        return;
      }

      // Handle Tuesday - check Monday's game
      if (dayOfWeek === 2) {
        const workoutType = getTuesdayWorkoutType(date);
        const mondayGame = getPreviousMondayGameInfo(date);

        if (workoutType === 'recovery') {
          previewTitle = 'Post-Late-Game Recovery';
          document.getElementById('previewTitle').textContent = previewTitle;
          document.getElementById('previewDate').textContent = `${dayNames[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}, 2026`;

          metaHtml = `<span> 20-25 min</span><span> Home</span>`;
          document.getElementById('previewMeta').innerHTML = metaHtml;

          contentHtml = '';
          if (mondayGame) {
            contentHtml += `
              <div style="padding: 12px; background: rgba(233,69,96,0.15); border-radius: 8px; border: 1px solid var(--accent); margin-bottom: 12px;">
                <div style="color: var(--accent-light); font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Why Recovery?</div>
                <p style="color: var(--text-secondary); font-size: 12px;">Monday's game ended at ${mondayGame.end} - late games require recovery focus</p>
              </div>
            `;
          }

          // Show recovery workout details
          const workoutData = WORKOUTS.tuesday.recovery;
          workoutData.circuits.forEach(circuit => {
            contentHtml += `
              <div class="preview-circuit">
                <div class="preview-circuit-name">${circuit.name}</div>
                <div class="preview-exercises">
            `;
            circuit.exercises.forEach(ex => {
              const repsText = ex.isHold ? `${ex.holdTime}s hold` :
                              ex.isCardio ? 'Complete' :
                              `${ex.reps} reps`;
              contentHtml += `${ex.name} (${ex.sets}x${repsText})<br>`;
            });
            contentHtml += `
                </div>
              </div>
            `;
          });

          document.getElementById('previewContent').innerHTML = contentHtml;
          document.getElementById('previewModal').classList.add('active');
          return;
        } else {
          // Upper body - show note about Monday if applicable
          previewTitle = 'Upper Body Focus';
          if (mondayGame && !mondayGame.isLate) {
            contentHtml = `
              <div style="padding: 12px; background: rgba(78,205,196,0.15); border-radius: 8px; border: 1px solid var(--success); margin-bottom: 12px;">
                <div style="color: var(--success); font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Good to Go</div>
                <p style="color: var(--text-secondary); font-size: 12px;">Monday's early game (ended ${mondayGame.end}) allows for Upper Body - check readiness 75+</p>
              </div>
            `;
          }
        }
      }

      document.getElementById('previewTitle').textContent = previewTitle;
      document.getElementById('previewDate').textContent = `${dayNames[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}, 2026`;

      if (!metaHtml) {
        if (schedule.duration) metaHtml += `<span> ${schedule.duration}</span>`;
        if (schedule.location) metaHtml += `<span> ${schedule.location}</span>`;
      }
      document.getElementById('previewMeta').innerHTML = metaHtml;

      if (schedule.type === 'rest') {
        contentHtml = `
          <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
            <div style="font-size: 32px; margin-bottom: 12px;"></div>
            <p>Recovery day - rest and recharge for the week ahead!</p>
          </div>
        `;
      } else if (schedule.external) {
        contentHtml += `
          <div style="padding: 16px; background: var(--bg-card); border-radius: 8px;">
            <div style="color: var(--warning); font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">External Activity</div>
            <p style="color: var(--text-secondary); font-size: 13px;">This workout is scheduled externally (team practice, personal training, etc.). Just show up and give it your best!</p>
          </div>
        `;
      } else if (schedule.workout) {
        // Get detailed workout info
        const workoutData = getWorkoutForDay(schedule.workout, date);
        if (workoutData) {
          workoutData.circuits.forEach(circuit => {
            contentHtml += `
              <div class="preview-circuit">
                <div class="preview-circuit-name">${circuit.name}</div>
                <div class="preview-exercises">
            `;
            circuit.exercises.forEach(ex => {
              const repsText = ex.isHold ? `${ex.holdTime}s hold` :
                              ex.isCardio ? 'Complete' :
                              `${ex.reps} reps`;
              contentHtml += `${ex.name} (${ex.sets}x${repsText})<br>`;
            });
            contentHtml += `
                </div>
              </div>
            `;
          });
        }
      }

      document.getElementById('previewContent').innerHTML = contentHtml;
      document.getElementById('previewModal').classList.add('active');
    }

    function getWorkoutForDay(dayKey, date) {
      switch(dayKey) {
        case 'tuesday':
          if (date) {
            const workoutType = getTuesdayWorkoutType(date);
            return workoutType === 'recovery' ? WORKOUTS.tuesday.recovery : WORKOUTS.tuesday.upperBody;
          }
          return WORKOUTS.tuesday.upperBody;
        case 'thursday': return WORKOUTS.thursday.bike;
        case 'friday': return WORKOUTS.friday.lowerBody;
        case 'saturday': return WORKOUTS.saturday.handball;
        default: return null;
      }
    }

    function closePreviewModal() {
      document.getElementById('previewModal').classList.remove('active');
    }

    // ==================== TRAVEL ACTIVITY LOGGING ====================
    function showTravelActivityModal() {
      // Reset selections
      document.querySelectorAll('#travelActivityTypes .activity-type-btn').forEach(b => b.classList.remove('selected'));
      document.querySelectorAll('#travelFeelSlider .travel-feel-btn').forEach(b => b.classList.remove('selected'));
      document.getElementById('travelActivityDescription').value = '';
      document.getElementById('travelActivityDuration').value = '';
      document.getElementById('travelActivityNotes').value = '';

      // Set up click handlers
      document.querySelectorAll('#travelActivityTypes .activity-type-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('#travelActivityTypes .activity-type-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        };
      });

      document.querySelectorAll('#travelFeelSlider .travel-feel-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('#travelFeelSlider .travel-feel-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        };
      });

      document.getElementById('travelActivityModal').classList.add('active');
    }

    function closeTravelActivityModal() {
      document.getElementById('travelActivityModal').classList.remove('active');
    }

    function saveTravelActivity() {
      const activityTypeBtn = document.querySelector('#travelActivityTypes .activity-type-btn.selected');
      const activityType = activityTypeBtn ? activityTypeBtn.dataset.value : 'other';
      const description = document.getElementById('travelActivityDescription').value;
      const duration = parseInt(document.getElementById('travelActivityDuration').value) || 0;
      const feelBtn = document.querySelector('#travelFeelSlider .travel-feel-btn.selected');
      const overallFeel = feelBtn ? parseInt(feelBtn.dataset.value) : 3;
      const notes = document.getElementById('travelActivityNotes').value;

      const activityNames = {
        hiking: 'Hiking',
        bodyweight: 'Bodyweight Workout',
        yoga: 'Yoga',
        walking: 'Walking',
        gym: 'Gym Workout',
        handball: 'Handball Training',
        other: 'Activity'
      };

      const workoutName = description || `${activityNames[activityType]} - ${state.currentTravelDay.location}`;

      const workoutData = {
        date: formatDateKey(state.currentDate),
        workout: workoutName,
        type: 'Travel Activity',
        activityType: activityType,
        duration: duration,
        location: state.currentTravelDay.location,
        overallFeel: overallFeel,
        notes: notes,
        travelContext: {
          facilities: state.currentTravelDay.facilities,
          isTraining: state.currentTravelDay.isTraining || false
        },
        timestamp: new Date().toISOString()
      };

      // Save to Firestore and localStorage
      saveWorkoutToHistory(workoutData);

      closeTravelActivityModal();
      loadTodaysWorkout(); // Refresh to show logged state
      loadHistory();
    }

    // ==================== EXTERNAL ACTIVITY LOGGING ====================
    let currentExternalActivity = null;

    function openExternalActivityModal(activityId, dayName) {
      const activities = EXTERNAL_ACTIVITIES[dayName];
      const activity = activities.find(a => a.id === activityId);

      if (!activity) return;

      currentExternalActivity = { ...activity, dayName };

      // Set title
      document.getElementById('externalActivityTitle').textContent = `Log ${activity.name}`;

      // Reset fields
      document.getElementById('externalActivityDuration').value = activity.duration || '';
      document.getElementById('externalActivityFocus').value = '';
      document.getElementById('externalActivityNotes').value = '';

      // Reset selections
      document.querySelectorAll('#externalIntensitySlider .overall-btn').forEach(b => b.classList.remove('selected'));
      document.querySelectorAll('#externalEffortType .effort-type-btn').forEach(b => b.classList.remove('selected'));

      // Set up click handlers
      document.querySelectorAll('#externalIntensitySlider .overall-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('#externalIntensitySlider .overall-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        };
      });

      document.querySelectorAll('#externalEffortType .effort-type-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('#externalEffortType .effort-type-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        };
      });

      document.getElementById('externalActivityModal').classList.add('active');
    }

    function closeExternalActivityModal() {
      document.getElementById('externalActivityModal').classList.remove('active');
      currentExternalActivity = null;
    }

    function saveExternalActivity() {
      if (!currentExternalActivity) return;

      const duration = parseInt(document.getElementById('externalActivityDuration').value) || currentExternalActivity.duration;
      const intensityBtn = document.querySelector('#externalIntensitySlider .overall-btn.selected');
      const intensity = intensityBtn ? parseInt(intensityBtn.dataset.value) : 5;
      const effortTypeBtn = document.querySelector('#externalEffortType .effort-type-btn.selected');
      const effortType = effortTypeBtn ? effortTypeBtn.dataset.value : null;
      const focus = document.getElementById('externalActivityFocus').value;
      const notes = document.getElementById('externalActivityNotes').value;

      const workoutData = {
        date: formatDateKey(state.currentDate),
        workout: currentExternalActivity.name,
        type: 'External Activity',
        activityId: currentExternalActivity.id,
        activityType: currentExternalActivity.type,
        duration: duration,
        location: currentExternalActivity.location,
        intensity: intensity,
        effortType: effortType,
        focus: focus,
        notes: notes,
        timestamp: new Date().toISOString()
      };

      // Save to Firestore and localStorage
      saveWorkoutToHistory(workoutData);

      closeExternalActivityModal();
      loadTodaysWorkout(); // Refresh to show logged state
      loadHistory();
    }

    // ==================== ADAPTATION RULES ENGINE ====================
    const ADAPTATION_RULES = [
      {
        id: 'very_low_readiness_rest',
        condition: (metrics) => metrics.readiness && metrics.readiness < 50,
        action: 'switch_to_rest',
        message: 'Readiness is very low ({readiness}) - rest day recommended'
      },
      {
        id: 'low_readiness_recovery',
        condition: (metrics) => metrics.readiness && metrics.readiness < 70,
        action: 'switch_to_recovery',
        message: 'Readiness is {readiness} - switching to Recovery'
      },
      {
        id: 'low_sleep_warning',
        condition: (metrics) => metrics.sleepScore && metrics.sleepScore < 70,
        action: 'warn_only',
        message: 'Sleep score is low ({sleepScore}) - monitor your energy'
      },
      {
        id: 'high_effort_yesterday',
        condition: (metrics) => {
          const history = getWorkoutHistory();
          if (history.length === 0) return false;
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayKey = formatDateKey(yesterday);
          const yesterdayWorkout = history.find(w => w.date === yesterdayKey);
          return yesterdayWorkout && yesterdayWorkout.overallFeel >= 8;
        },
        action: 'suggest_lighter',
        message: 'Yesterday was intense - consider lighter intensity today'
      }
    ];

    function applyAdaptationRules(metrics) {
      const triggeredRules = [];

      for (const rule of ADAPTATION_RULES) {
        if (rule.condition(metrics)) {
          let message = rule.message;
          if (metrics.readiness) message = message.replace('{readiness}', metrics.readiness);
          if (metrics.sleepScore) message = message.replace('{sleepScore}', metrics.sleepScore);
          triggeredRules.push({
            ...rule,
            message
          });
          // Stop at first major action (rest or recovery)
          if (rule.action === 'switch_to_rest' || rule.action === 'switch_to_recovery') {
            break;
          }
        }
      }

      return triggeredRules;
    }

    function renderAdaptationBanner(rules, originalWorkout) {
      if (!rules || rules.length === 0) return '';

      const mainRule = rules[0];
      const actionMessages = {
        'switch_to_rest': 'Workout switched to Rest Day',
        'switch_to_recovery': 'Workout switched to Recovery',
        'suggest_lighter': 'Consider lighter intensity',
        'warn_only': 'Note for today'
      };

      return `
        <div class="adaptation-banner" id="adaptationBanner">
          <div class="adaptation-banner-header">
            <span>Adapted based on your metrics</span>
          </div>
          <div class="adaptation-banner-message">
            ${mainRule.message}
          </div>
          ${originalWorkout ? `
            <button class="adaptation-banner-action" onclick="showOriginalWorkout()">
              Show Original Workout Instead
            </button>
          ` : ''}
        </div>
      `;
    }

    // Store original workout when adapting
    let originalScheduledWorkout = null;
    let adaptationApplied = null;

    function showOriginalWorkout() {
      if (originalScheduledWorkout) {
        adaptationApplied = null;
        state.activeWorkout = originalScheduledWorkout;
        renderWorkout(originalScheduledWorkout);
        originalScheduledWorkout = null;
      }
    }

    // ==================== ADJUSTMENT CAPTURE ====================
    let currentAdjustment = null;

    function showAdjustmentModal() {
      // Reset
      document.querySelectorAll('#adjustmentTypeChips .reason-chip').forEach(b => b.classList.remove('selected'));
      document.querySelectorAll('#adjustmentReasonChips .reason-chip').forEach(b => b.classList.remove('selected'));
      document.getElementById('adjustmentNotes').value = '';

      // Set up click handlers for multi-select
      document.querySelectorAll('#adjustmentTypeChips .reason-chip').forEach(btn => {
        btn.onclick = () => btn.classList.toggle('selected');
      });
      document.querySelectorAll('#adjustmentReasonChips .reason-chip').forEach(btn => {
        btn.onclick = () => btn.classList.toggle('selected');
      });

      document.getElementById('adjustmentModal').classList.add('active');
    }

    function closeAdjustmentModal() {
      document.getElementById('adjustmentModal').classList.remove('active');
    }

    function saveAdjustment() {
      const types = Array.from(document.querySelectorAll('#adjustmentTypeChips .reason-chip.selected'))
        .map(b => b.dataset.value);
      const reasons = Array.from(document.querySelectorAll('#adjustmentReasonChips .reason-chip.selected'))
        .map(b => b.dataset.value);
      const notes = document.getElementById('adjustmentNotes').value;

      if (types.length === 0) {
        closeAdjustmentModal();
        return;
      }

      currentAdjustment = {
        exercise: state.currentExercise.data.name,
        exerciseId: state.currentExercise.id,
        setNumber: state.currentSet + 1,
        types: types,
        reasons: reasons,
        note: notes,
        timestamp: new Date().toISOString()
      };

      // Add to workout log adjustments
      if (!state.workoutAdjustments) {
        state.workoutAdjustments = [];
      }
      state.workoutAdjustments.push(currentAdjustment);

      closeAdjustmentModal();
    }

    // ==================== INSIGHTS & PATTERNS ====================
    function calculatePatterns() {
      const history = getWorkoutHistory();
      const threeWeeksAgo = new Date();
      threeWeeksAgo.setDate(threeWeeksAgo.getDate() - 21);

      const recentWorkouts = history.filter(w => new Date(w.date) >= threeWeeksAgo);

      const patterns = {
        totalWorkouts: recentWorkouts.length,
        avgReadiness: 0,
        lowReadinessDays: 0,
        adjustmentReasons: {},
        adjustedExercises: {},
        adaptedWorkouts: 0,
        travelActivities: 0
      };

      let readinessSum = 0;
      let readinessCount = 0;

      recentWorkouts.forEach(workout => {
        // Count readiness
        if (workout.readiness) {
          readinessSum += workout.readiness;
          readinessCount++;
          if (workout.readiness < 70) patterns.lowReadinessDays++;
        }

        // Count travel activities
        if (workout.type === 'Travel Activity') {
          patterns.travelActivities++;
        }

        // Count adaptations
        if (workout.wasAdapted) {
          patterns.adaptedWorkouts++;
        }

        // Count adjustments
        if (workout.adjustments) {
          workout.adjustments.forEach(adj => {
            // Count by reason
            if (adj.reasons) {
              adj.reasons.forEach(reason => {
                patterns.adjustmentReasons[reason] = (patterns.adjustmentReasons[reason] || 0) + 1;
              });
            }
            // Count by exercise
            if (adj.exercise) {
              patterns.adjustedExercises[adj.exercise] = (patterns.adjustedExercises[adj.exercise] || 0) + 1;
            }
          });
        }
      });

      patterns.avgReadiness = readinessCount > 0 ? Math.round(readinessSum / readinessCount) : null;

      return patterns;
    }

    function renderInsightsSection() {
      const patterns = calculatePatterns();

      if (patterns.totalWorkouts < 3) {
        return ''; // Not enough data yet
      }

      let insightsHtml = `
        <div class="insights-section">
          <div class="insights-header">
            <span>Patterns (Last 3 Weeks)</span>
          </div>
      `;

      // Readiness patterns
      if (patterns.avgReadiness) {
        insightsHtml += `
          <div class="insight-card">
            <div class="insight-title">Readiness Patterns</div>
            <div class="insight-item">
              <span>Average readiness</span>
              <span class="insight-value">${patterns.avgReadiness}</span>
            </div>
            <div class="insight-item">
              <span>Days below 70</span>
              <span class="insight-value">${patterns.lowReadinessDays}</span>
            </div>
            ${patterns.adaptedWorkouts > 0 ? `
            <div class="insight-item">
              <span>Workouts adapted</span>
              <span class="insight-value">${patterns.adaptedWorkouts}</span>
            </div>
            ` : ''}
          </div>
        `;
      }

      // Adjustment patterns
      const reasonEntries = Object.entries(patterns.adjustmentReasons).sort((a, b) => b[1] - a[1]);
      const exerciseEntries = Object.entries(patterns.adjustedExercises).sort((a, b) => b[1] - a[1]);

      if (reasonEntries.length > 0) {
        const reasonLabels = {
          fatigue: 'Fatigue',
          discomfort: 'Discomfort',
          time: 'Time constraints',
          form: 'Form issues'
        };

        insightsHtml += `
          <div class="insight-card">
            <div class="insight-title">Adjustments by Reason</div>
            ${reasonEntries.slice(0, 4).map(([reason, count]) => `
              <div class="insight-item">
                <span>${reasonLabels[reason] || reason}</span>
                <span class="insight-value">${count}x</span>
              </div>
            `).join('')}
          </div>
        `;
      }

      if (exerciseEntries.length > 0) {
        insightsHtml += `
          <div class="insight-card">
            <div class="insight-title">Most Adjusted Exercises</div>
            ${exerciseEntries.slice(0, 3).map(([exercise, count]) => `
              <div class="insight-item">
                <span>${exercise}</span>
                <span class="insight-value">${count} adjustments</span>
              </div>
            `).join('')}
          </div>
        `;
      }

      // Travel activities
      if (patterns.travelActivities > 0) {
        insightsHtml += `
          <div class="insight-card">
            <div class="insight-title">Travel Days</div>
            <div class="insight-item">
              <span>Activities logged</span>
              <span class="insight-value">${patterns.travelActivities}</span>
            </div>
          </div>
        `;
      }

      insightsHtml += `</div>`;
      return insightsHtml;
    }

    // ==================== AI COACH ====================

    const COACH_CONTEXT = `ATHLETE PROFILE
- 31F, 6'3", 170 lbs. Multi-sport: soccer (Mon), handball (Wed+Sat), cycling/Beer Bike (Thu), strength (Tue+Fri).
- Uses Oura Ring for readiness. Works with personal trainer Monday 4pm.
- Equipment at home: Tribe fabric resistance bands (5 levels, light to X-heavy), handball, foam roller.
- Reference: @handballstrength on Instagram.

GOALS
1. US Women's Handball Team tryouts (fall 2026) - PRIMARY
2. Beer Bike race (late April 2026) - 2-lap time trial, current 1:51, goal 1:40
3. General strength and injury prevention

WEEKLY SCHEDULE (Mon-Sun)
- Mon: Personal training (4pm) + Soccer (evening, 7v7). Game times vary; check SPECIAL_DATES.
- Tue: Upper Body (if Mon game ended early + readiness 75+) OR Post-Late-Game Recovery (if late Mon game or readiness 70-75). Recovery = mobility + band shoulder work at home.
- Wed: Handball practice (7-9pm, 90 min). External, not programmed.
- Thu: Bike training (45-60 min, outdoor track) + Shoulder Stability Protocol (15-20 min post-ride).
- Fri: Lower Body (if readiness 80+ and legs good) OR Yoga only (55 min Hatha, 6:30pm) if readiness 75-80 or legs heavy.
- Sat: Soccer (2-3pm, 45 min) + Handball skill session (45-60 min, squash court/wall).
- Sun: REST. Non-negotiable.

READINESS THRESHOLDS
- 85+: Full speed, push intensity
- 75-84: Proceed with plan, monitor
- 70-74: Reduce volume/intensity by ~25%, consider recovery variant
- <70: Rest day or very easy movement only
- <70 for 3+ consecutive days: RED FLAG - back off significantly, check sleep/stress/nutrition

HANDBALL PRIORITIES
- Jump shot technique: L-R-LEFT rhythm (right hand), explosive 3rd step, land on same foot
- Left-hand development: distance progression (2m/4m/6m), standing shots, one-step jump shots
- Shoulder stability: rotator cuff protocol (90/90 rotations, empty/full can, prone T's, scapular push-ups)
- Watching handball games counts as valid training (tactical study, positioning, play recognition)
- Left-hand milestones: Wk2 hit target 4m, Wk4 jump shot with left, Wk6 natural in drills, Wk8 confident in practice

BEER BIKE (11-week plan, ~Week ${Math.max(1, Math.ceil((new Date() - new Date(2026, 1, 6)) / (7 * 86400000)))} of 11)
- Thu sessions: Wk1-3 base (tempo intervals, cadence 85-95 RPM), Wk4-6 race-specific (race pace, speed endurance), Wk7-9 simulation (full race efforts, overspeed), Wk10-11 taper
- Clipping practice every session until automatic
- Key mental cues: "Smooth is fast," "High cadence, light pressure"
- Race strategy: Lap 1 ~52-53sec controlled, Lap 2 ~47-48sec all-out, commit halfway through Lap 1

SHOULDER PROTOCOL (do after biking and after Saturday soccer)
- A. Activation: scapular squeezes, arm circles palms up (3 min)
- B. Rotator cuff: 90/90 ext/int rotation 3x12, empty/full can, prone T's, dynamic ext rotation (10-12 min)
- C. Scapular stability: scapular push-ups, bear plank shoulder taps (3-4 min)
- D. Overhead endurance: overhead hold + ball squeeze 2x30sec each arm (2-3 min)

TUESDAY UPPER BODY EXERCISES
Circuit A: Single Arm DB Row (3x10 @15lb ea arm), Chest Press Machine (3x10 @70lb), Russian Twists w/ Weight (3x20 @20lb)
Circuit B: Lateral Shoulder Raise (3x10 @5lb), Lat Pulldown Machine (3x10 @55lb), Weighted Sit-ups (3x12 @5lb)
Circuit C: Bicep Curls (3x10 @7.5lb), Cable Tricep Extension (3x10 @25lb)

FRIDAY LOWER BODY EXERCISES
Circuit A: DB Goblet Squat (3x12 @25lb), Jump Squats (3x10 BW), Front Low Plank (3x30sec)
Circuit B: DB Reverse Lunges (3x8 @15lb ea leg), DB RDLs (3x10 @15lb), Side Plank (3x25sec ea side)
Circuit C: Leg Press Machine (3x10 @100lb), Hamstring Curl Machine (3x10 @50lb)

OVERTRAINING SIGNALS & GUARDRAILS
- Sharp pain during movement = STOP immediately
- Persistent pain >24h = extra rest, consider medical
- Significant performance decrease = reduce load
- Can't maintain form = drop weight or switch to recovery
- Tendency to overtrain: athlete pushes through when she should rest. Coach should err on side of caution.
- Better to do 80% of a workout well than 100% poorly
- Sunday is always rest. No exceptions.`;

    // Coach conversation state
    let coachMessages = [];
    const COACH_MAX_HISTORY = 10; // message pairs

    function toggleCoachSettings() {
      const body = document.getElementById('coachSettingsBody');
      const toggle = document.getElementById('coachSettingsToggle');
      body.classList.toggle('hidden');
      toggle.classList.toggle('collapsed');
    }

    function saveCoachSettings() {
      const url = document.getElementById('coachProxyUrl').value.trim();
      if (url) {
        localStorage.setItem('coachProxyUrl', url);
        // Collapse settings after save
        document.getElementById('coachSettingsBody').classList.add('hidden');
        document.getElementById('coachSettingsToggle').classList.add('collapsed');
      }
    }

    function initCoachView() {
      const savedUrl = localStorage.getItem('coachProxyUrl');
      if (savedUrl) {
        document.getElementById('coachProxyUrl').value = savedUrl;
        // Auto-collapse if already configured
        document.getElementById('coachSettingsBody').classList.add('hidden');
        document.getElementById('coachSettingsToggle').classList.add('collapsed');
      }
    }

    function summarizeRecentHistory() {
      const history = getWorkoutHistory();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      const recent = history.filter(w => new Date(w.date) >= sevenDaysAgo);
      if (recent.length === 0) return 'No workouts logged in the last 7 days.';

      let summary = 'LAST 7 DAYS:\n';
      recent.forEach(w => {
        const d = new Date(w.date);
        const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        summary += `\n${dayNames[d.getDay()]} ${w.date} - ${w.name || w.type || 'Workout'}`;
        if (w.readiness) summary += ` | Readiness: ${w.readiness}`;
        if (w.overallFeel) summary += ` | Feel: ${w.overallFeel}/10`;
        if (w.overallEffortType) summary += ` | Effort: ${w.overallEffortType}`;
        if (w.wasAdapted) summary += ` | AUTO-ADAPTED: ${w.adaptReason || 'readiness'}`;

        // Exercise details
        if (w.exerciseLog) {
          Object.entries(w.exerciseLog).forEach(([id, log]) => {
            if (log.sets && log.sets.length > 0) {
              const setDetails = log.sets.map((s, i) => {
                let detail = `S${i+1}`;
                if (s.reps) detail += `:${s.reps}r`;
                if (s.weight) detail += `@${s.weight}lb`;
                if (s.feel) detail += `(feel:${s.feel}/5)`;
                if (s.effortType) detail += `[${s.effortType}]`;
                return detail;
              }).join(' ');
              summary += `\n  ${log.name || id}: ${setDetails}`;
            }
          });
        }

        // Adjustments
        if (w.adjustments && w.adjustments.length > 0) {
          w.adjustments.forEach(adj => {
            summary += `\n  ADJUSTED ${adj.exercise}: ${adj.reasons ? adj.reasons.join(', ') : 'unspecified'} -> ${adj.change || 'modified'}`;
          });
        }

        // Notes
        if (w.notes) summary += `\n  Notes: "${w.notes}"`;
      });

      // Add patterns
      const patterns = calculatePatterns();
      if (patterns.totalWorkouts >= 2) {
        summary += `\n\n3-WEEK PATTERNS: ${patterns.totalWorkouts} workouts`;
        if (patterns.avgReadiness) summary += `, avg readiness ${patterns.avgReadiness}`;
        if (patterns.lowReadinessDays > 0) summary += `, ${patterns.lowReadinessDays} days below 70`;
        if (patterns.adaptedWorkouts > 0) summary += `, ${patterns.adaptedWorkouts} auto-adapted`;

        const topAdj = Object.entries(patterns.adjustedExercises).sort((a,b) => b[1]-a[1]).slice(0,3);
        if (topAdj.length > 0) {
          summary += `\nMost adjusted: ${topAdj.map(([name, count]) => `${name} (${count}x)`).join(', ')}`;
        }
      }

      return summary;
    }

    function buildCoachSystemPrompt() {
      const today = state.currentDate;
      const dateKey = formatDateKey(today);
      const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      const dayOfWeek = today.getDay();
      const specialDate = SPECIAL_DATES[dateKey];

      // Get today's scheduled workout
      const schedule = SCHEDULE[dayOfWeek];
      let todaySchedule = `Today: ${dayNames[dayOfWeek]}, ${dateKey}. Scheduled: ${schedule.name}`;
      if (schedule.duration) todaySchedule += ` (${schedule.duration})`;
      if (specialDate) {
        todaySchedule += `\nSpecial: ${specialDate.note || ''}`;
        if (specialDate.location) todaySchedule += ` (${specialDate.location})`;
        if (specialDate.facilities) todaySchedule += ` [facilities: ${specialDate.facilities}]`;
      }

      // Readiness state
      let readinessInfo = 'Readiness: not entered yet';
      if (state.readiness) {
        readinessInfo = `Readiness: ${state.readiness}`;
        if (state.readiness >= 85) readinessInfo += ' (excellent - full intensity)';
        else if (state.readiness >= 75) readinessInfo += ' (good - proceed with plan)';
        else if (state.readiness >= 70) readinessInfo += ' (moderate - consider reducing 25%)';
        else readinessInfo += ' (low - rest or easy movement only)';
      }
      if (state.sleepScore) readinessInfo += ` | Sleep: ${state.sleepScore}`;
      if (state.hrv) readinessInfo += ` | HRV: ${state.hrv}`;

      const recentHistory = summarizeRecentHistory();

      return `You are Sophie's AI workout coach. You are warm, direct, knowledgeable, and concise. You understand her training plan intimately and help her make smart decisions about workouts, recovery, and progression.

KEY RULES:
- Always consider readiness score before recommending intensity
- Err on the side of caution - Sophie tends to push through when she should rest
- Sunday is always rest. Never suggest training on Sunday.
- If readiness < 70, strongly recommend rest or very light movement
- Watching handball games/film counts as valid training
- When suggesting workouts, use her actual exercises and weights from the plan
- Keep responses concise and actionable. Use bullet points for workout plans.
- Format workout suggestions clearly: exercise name, sets x reps, weight if applicable
- Never suggest exercises that could aggravate shoulders without proper warm-up/protocol

CURRENT STATE:
${todaySchedule}
${readinessInfo}

${COACH_CONTEXT}

RECENT TRAINING LOG:
${recentHistory}`;
    }

    function renderCoachMessage(text, role) {
      const container = document.getElementById('coachMessages');
      const welcome = container.querySelector('.coach-welcome');
      if (welcome) welcome.remove();

      const div = document.createElement('div');

      if (role === 'error') {
        div.className = 'coach-msg coach-msg-error';
        div.textContent = text;
      } else if (role === 'user') {
        div.className = 'coach-msg coach-msg-user';
        div.textContent = text;
      } else {
        div.className = 'coach-msg coach-msg-assistant';
        div.innerHTML = simpleMarkdown(text);
      }

      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function simpleMarkdown(text) {
      // Convert markdown to HTML (basic support)
      return text
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`(.+?)`/g, '<code>$1</code>')
        .replace(/^### (.+)$/gm, '<strong style="font-size:15px;">$1</strong>')
        .replace(/^## (.+)$/gm, '<strong style="font-size:16px;">$1</strong>')
        .replace(/^[-*] (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
        .replace(/<\/ul>\s*<ul>/g, '')
        .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
        .replace(/\n{2,}/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/^/, '<p>').replace(/$/, '</p>')
        .replace(/<p><\/p>/g, '')
        .replace(/<p>(<ul>)/g, '$1')
        .replace(/(<\/ul>)<\/p>/g, '$1');
    }

    function showTypingIndicator() {
      const container = document.getElementById('coachMessages');
      const typing = document.createElement('div');
      typing.className = 'coach-typing';
      typing.id = 'coachTyping';
      typing.innerHTML = '<div class="coach-typing-dot"></div><div class="coach-typing-dot"></div><div class="coach-typing-dot"></div>';
      container.appendChild(typing);
      container.scrollTop = container.scrollHeight;
    }

    function hideTypingIndicator() {
      const typing = document.getElementById('coachTyping');
      if (typing) typing.remove();
    }

    async function sendCoachMessage(overrideText) {
      const input = document.getElementById('coachInput');
      const userText = overrideText || input.value.trim();
      if (!userText) return;

      const proxyUrl = localStorage.getItem('coachProxyUrl');
      if (!proxyUrl) {
        renderCoachMessage('Set up your Cloudflare Worker URL in the settings above first.', 'error');
        return;
      }

      // Clear input and show user message
      if (!overrideText) input.value = '';
      renderCoachMessage(userText, 'user');

      // Add to conversation history
      coachMessages.push({ role: 'user', content: userText });

      // Trim history to last N pairs
      while (coachMessages.length > COACH_MAX_HISTORY * 2) {
        coachMessages.shift();
      }

      // Disable send
      document.getElementById('coachSendBtn').disabled = true;
      showTypingIndicator();

      try {
        const systemPrompt = buildCoachSystemPrompt();
        const response = await fetch(proxyUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            system: systemPrompt,
            messages: coachMessages.map(m => ({ role: m.role, content: m.content }))
          })
        });

        if (!response.ok) {
          const errText = await response.text();
          throw new Error(`API error ${response.status}: ${errText.slice(0, 200)}`);
        }

        const data = await response.json();
        const assistantText = data.content?.[0]?.text || data.text || 'No response received.';

        coachMessages.push({ role: 'assistant', content: assistantText });
        hideTypingIndicator();
        renderCoachMessage(assistantText, 'assistant');
        saveCoachSession();
      } catch (err) {
        hideTypingIndicator();
        renderCoachMessage(`Error: ${err.message}`, 'error');
        // Remove the failed user message from history so conversation stays clean
        coachMessages.pop();
      } finally {
        document.getElementById('coachSendBtn').disabled = false;
        document.getElementById('coachInput').focus();
      }
    }

    function sendQuickAction(type) {
      const actions = {
        adapt: `My readiness is ${state.readiness || 'not entered yet'}. What adaptations should I make to today's scheduled workout?`,
        design: `I have some free time. Can you design a workout for me? I'm at ${isTravelDay(state.currentDate) ? 'a travel location with ' + (SPECIAL_DATES[formatDateKey(state.currentDate)]?.facilities || 'minimal') + ' facilities' : 'home/campus with gym access'}.`,
        rest: `Should I rest today? My readiness is ${state.readiness || 'not entered yet'}. How am I trending this week?`
      };
      sendCoachMessage(actions[type]);
    }

    // ==================== COACH SESSION PERSISTENCE ====================
    // Save coach conversations to Firebase so terminal agent can reference them
    function saveCoachSession() {
      if (coachMessages.length === 0) return;

      const dateKey = formatDateKey(state.currentDate);
      const sessionData = {
        date: dateKey,
        messages: coachMessages.map(m => ({ role: m.role, content: m.content })),
        readiness: state.readiness,
        updatedAt: new Date().toISOString()
      };

      // Save to Firebase (merge with existing session for today)
      db.collection('coachSessions').doc(dateKey).set(sessionData, { merge: true })
        .then(() => console.log('[Coach] Session saved to cloud'))
        .catch((err) => console.log('[Coach] Error saving session:', err));

      // Backup to localStorage
      localStorage.setItem(`coachSession_${dateKey}`, JSON.stringify(sessionData));
    }

    // ==================== START ====================
    init();
    initCoachView();
  </script>
</body>
</html>
